<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Ultra Link å¤šåŠŸèƒ½è°ƒè¯•ç»ˆç«¯</title>
    <link rel="stylesheet" href="https://unpkg.com/uplot/dist/uPlot.min.css">
    <script src="https://unpkg.com/uplot/dist/uPlot.iife.min.js"></script>
    
    <style>
        :root { --bg: #1e1e1e; --panel: #2d2d2d; --primary: #007acc; --text: #eaeaea; --danger: #cc3300; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .topbar { background: #111; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 10; }
        .topbar h2 { margin: 0; font-size: 1.2rem; color: #4fc3f7; }
        button { background: var(--primary); color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px; font-size: 14px; transition: 0.2s; }
        button:hover { background: #005f9e; }
        button.danger { background: var(--danger); }
        button.danger:hover { background: #990000; }
        button.back-btn { background: #555; margin-right: 15px; }
        button.back-btn:hover { background: #777; }

        /* é¡µé¢å®¹å™¨ä¸åˆ‡æ¢åŠ¨ç”» */
        .view-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .page { display: none; animation: fadeIn 0.3s ease; flex: 1; flex-direction: column; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ä¸»é¡µç½‘æ ¼èœå• */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; max-width: 1000px; margin: 20px auto; width: 100%; }
        .menu-card { background: var(--panel); border: 1px solid #444; border-radius: 12px; padding: 30px 20px; text-align: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 8px 15px rgba(0,122,204,0.3); }
        .menu-card h3 { margin: 0 0 10px 0; font-size: 1.4rem; color: #fff; }
        .menu-card p { margin: 0; color: #aaa; font-size: 0.9rem; }

        /* å­åŠŸèƒ½é¡µé¢é€šç”¨æ ·å¼ */
        .panel { background: var(--panel); padding: 20px; border-radius: 8px; border: 1px solid #444; flex: 1; display: flex; flex-direction: column; }
        .control-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        input, select { background: #111; border: 1px solid #555; color: #0f0; padding: 8px; border-radius: 4px; font-family: monospace; }
        input:focus { outline: none; border-color: var(--primary); }
        textarea { flex: 1; width: 100%; background: #000; color: #0f0; border: 1px solid #555; padding: 10px; box-sizing: border-box; font-family: 'Consolas', monospace; resize: none; border-radius: 4px; }
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="topbar">
        <div style="display: flex; align-items: center;">
            <button id="btn-back" class="back-btn" style="display: none;" onclick="goHome()">â—€ è¿”å›ä¸»èœå•</button>
            <h2 id="page-title">Ultra Link æ€»æ§åˆ¶å°</h2>
        </div>
        <div>
            <span id="usb-status" style="color: #ff5252; margin-right: 15px; font-weight: bold;">â— æœªè¿æ¥ (Workerä¼‘çœ )</span>
            <button id="btn-connect" onclick="connectUSB()">è¿æ¥ç¡¬ä»¶</button>
            <button id="btn-disconnect" class="danger" onclick="disconnectUSB()" style="display:none;">æ–­å¼€è¿æ¥</button>
        </div>
    </div>

    <div class="view-container">
        
        <div id="page-home" class="page active">
            <div class="menu-grid">
                <div class="menu-card" onclick="navTo('page-scope', 'å®æ—¶æ³¢å½¢ç¤ºæ³¢å™¨')" style="border-color: #ff9800;">
                    <h3 style="color: #ff9800;">ğŸ“ˆ å®æ—¶æ³¢å½¢</h3><p>é«˜é€Ÿå¤šçº¿ç¨‹å›¾å½¢æ¸²æŸ“å¼•æ“</p>
                </div>
                <div class="menu-card" onclick="navTo('page-uart1', 'UART 1 è°ƒè¯•ç»ˆç«¯')">
                    <h3>ğŸ“Ÿ UART 1</h3><p>ä¸»æ§å…¨åŠŸèƒ½ä¸²å£æ”¶å‘</p>
                </div>
                <div class="menu-card" onclick="navTo('page-uart2', 'UART 2 è°ƒè¯•ç»ˆç«¯')">
                    <h3>ğŸ“Ÿ UART 2</h3><p>è¾…åŠ©å¤–è®¾ç›‘æ§ä¸²å£</p>
                </div>
                <div class="menu-card" onclick="navTo('page-can', 'CAN æ€»çº¿åˆ†æä»ª')">
                    <h3>ğŸšŒ CAN Bus</h3><p>æŠ¥æ–‡æ”¶å‘ / æ ‡å‡†/æ‰©å±•å¸§</p>
                </div>
                <div class="menu-card" onclick="navTo('page-i2c', 'I2C å¯„å­˜å™¨è°ƒè¯•')">
                    <h3>ğŸ”Œ I2C Master</h3><p>è®¾å¤‡æ‰«æ / å¯„å­˜å™¨è¯»å†™</p>
                </div>
                <div class="menu-card" onclick="navTo('page-analog', 'æ¨¡æ‹Ÿé‡ä¸å¤–è®¾ (PWM/DAC)')">
                    <h3>âš¡ PWM / DAC</h3><p>å ç©ºæ¯”è°ƒèŠ‚ / æ¨¡æ‹Ÿç”µå‹è¾“å‡º</p>
                </div>
            </div>
        </div>

        <div id="page-scope" class="page">
            <div class="panel">
                <div class="toolbar">
                    <span style="font-size: 14px; color: #aaa;">é‡‡æ ·ç‡: <span id="fps-counter" style="color:#00e676; font-weight: bold; font-size: 16px;">0</span> ç‚¹/ç§’</span>
                    <button class="danger" onclick="clearChart()">æ¸…ç©ºæ³¢å½¢</button>
                </div>
                <div id="chart-container" style="flex: 1; background: #000; border-radius: 4px; border: 1px solid #444; width: 100%; min-height: 400px;"></div>
            </div>
        </div>

        <div id="page-uart1" class="page">
            <div class="panel">
                <div class="toolbar">
                    <div class="control-group" style="margin: 0;">
                        <select id="u1-baud">
                            <option value="9600">9600</option>
                            <option value="115200" selected>115200</option>
                            <option value="2000000">2000000</option>
                        </select>
                        <button onclick="sendCMD('CFG_U1', document.getElementById('u1-baud').value)">åº”ç”¨æ³¢ç‰¹ç‡</button>
                    </div>
                    <button class="danger" onclick="document.getElementById('u1-rx').value=''">æ¸…ç©ºå±å¹•</button>
                </div>
                <textarea id="u1-rx" readonly placeholder="ç­‰å¾…å¤šçº¿ç¨‹æ¥æ”¶ UART1 æ•°æ®..."></textarea>
                <div class="control-group" style="margin-top: 15px;">
                    <input type="text" id="u1-tx" placeholder="è¾“å…¥è¦å‘é€çš„å†…å®¹..." style="flex: 1;">
                    <button onclick="sendCMD('TX_U1', document.getElementById('u1-tx').value)">å‘é€</button>
                </div>
            </div>
        </div>

        <div id="page-uart2" class="page">
            <div class="panel">
                <div class="toolbar">
                    <h3 style="margin: 0; color: #aaa; font-size: 14px;">UART 2 æ¥æ”¶åŒº</h3>
                    <button class="danger" onclick="document.getElementById('u2-rx').value=''">æ¸…ç©ºå±å¹•</button>
                </div>
                <textarea id="u2-rx" readonly placeholder="ç­‰å¾…å¤šçº¿ç¨‹æ¥æ”¶ UART2 æ•°æ®..."></textarea>
                <div class="control-group" style="margin-top: 15px;">
                    <input type="text" id="u2-tx" placeholder="è¾“å…¥è¦å‘é€çš„å†…å®¹..." style="flex: 1;">
                    <button onclick="sendCMD('TX_U2', document.getElementById('u2-tx').value)">å‘é€</button>
                </div>
            </div>
        </div>

        <div id="page-can" class="page">
            <div class="panel">
                <h3 style="margin-top: 0; color: #4fc3f7;">å‘é€ CAN æŠ¥æ–‡</h3>
                <div class="control-group">
                    <select id="can-type"><option value="STD">æ ‡å‡†å¸§ (STD)</option><option value="EXT">æ‰©å±•å¸§ (EXT)</option></select>
                    ID (Hex): <input type="text" id="can-id" placeholder="123" size="8">
                    Data (Hex): <input type="text" id="can-data" placeholder="11 22 33 44 55 66 77 88" style="flex: 1;">
                    <button onclick="sendCMD('CAN_TX', document.getElementById('can-id').value + '|' + document.getElementById('can-data').value)">å‘é€æŠ¥æ–‡</button>
                </div>
                <hr style="border-color: #444; margin: 15px 0; width: 100%;">
                <h3 style="margin-top: 0; color: #4fc3f7;">æ¥æ”¶è®°å½•</h3>
                <textarea id="can-rx" readonly placeholder="CAN æ€»çº¿æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            </div>
        </div>

        <div id="page-i2c" class="page">
            <div class="panel">
                <h3 style="margin-top: 0; color: #4fc3f7;">I2C ä¸»æœºæ¨¡å¼æ§åˆ¶</h3>
                <div class="control-group">
                    <button onclick="sendCMD('I2C_SCAN', '')">æ‰«ææ€»çº¿è®¾å¤‡ (Scan)</button>
                </div>
                <div class="control-group">
                    è®¾å¤‡åœ°å€ (Hex): <input type="text" id="i2c-addr" placeholder="50" size="6">
                    å¯„å­˜å™¨ (Hex): <input type="text" id="i2c-reg" placeholder="00" size="6">
                    è¯»å–é•¿åº¦: <input type="number" id="i2c-len" value="1" min="1" max="32" style="width: 60px;">
                    <button onclick="sendCMD('I2C_READ', '')" style="background: #28a745;">è¯»å– (Read)</button>
                </div>
                <div class="control-group">
                    å†™å…¥æ•°æ® (Hex): <input type="text" id="i2c-write-data" placeholder="FF" style="flex: 1;">
                    <button onclick="sendCMD('I2C_WRITE', '')" class="danger">å†™å…¥ (Write)</button>
                </div>
                <textarea id="i2c-log" readonly style="height: 150px; flex: none;" placeholder="æ“ä½œæ—¥å¿—..."></textarea>
            </div>
        </div>

        <div id="page-analog" class="page">
            <div class="panel">
                <h3 style="margin-top: 0; color: #4fc3f7;">PWM è¾“å‡ºé…ç½®</h3>
                <div class="control-group">
                    é¢‘ç‡ (Hz): <input type="number" id="pwm-freq" value="1000" style="width: 100px;">
                    <button onclick="sendCMD('PWM_FREQ', document.getElementById('pwm-freq').value)">è®¾ç½®é¢‘ç‡</button>
                </div>
                <div class="control-group">
                    å ç©ºæ¯”: <input type="range" id="pwm-duty" min="0" max="100" value="50" style="width: 300px;" oninput="document.getElementById('pwm-val').innerText = this.value + '%'">
                    <span id="pwm-val" style="display:inline-block; width: 50px; color: #0f0;">50%</span>
                    <button onclick="sendCMD('PWM_DUTY', document.getElementById('pwm-duty').value)">å®æ—¶åº”ç”¨</button>
                </div>
                
                <hr style="border-color: #444; margin: 20px 0; width: 100%;">
                
                <h3 style="margin-top: 0; color: #4fc3f7;">DAC æ¨¡æ‹Ÿé‡è¾“å‡º</h3>
                <div class="control-group">
                    è¾“å‡ºç”µå‹ (mV): <input type="number" id="dac-mv" value="1500" min="0" max="3300" style="width: 100px;">
                    <button onclick="sendCMD('DAC_OUT', document.getElementById('dac-mv').value)">è®¾ç½®ç”µå‹</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // 1. é¡µé¢è·¯ç”±ä¸ UI åˆ‡æ¢é€»è¾‘
        // ==========================================
        function navTo(pageId, title) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(pageId).classList.add('active');
            // ä¿®æ”¹æ ‡é¢˜å’Œè¿”å›æŒ‰é’®
            document.getElementById('page-title').innerText = title;
            document.getElementById('btn-back').style.display = 'inline-block';

            // ã€é‡ç‚¹ä¿®è¡¥ã€‘ï¼šå¦‚æœè¿›å…¥äº†æ³¢å½¢å›¾é¡µé¢ï¼Œç”±äºä¹‹å‰éšè—æ—¶å®½åº¦ä¸º0ï¼Œéœ€è¦é‡æ–°è§¦å‘å›¾è¡¨è‡ªé€‚åº”å°ºå¯¸
            if(pageId === 'page-scope') {
                setTimeout(() => {
                    const chartDiv = document.getElementById("chart-container");
                    if (uplot && chartDiv.clientWidth > 0) {
                        uplot.setSize({ width: chartDiv.clientWidth, height: chartDiv.clientHeight });
                    }
                }, 50); // ç»™ DOM æ¸²æŸ“ç•™ 50ms çš„å–˜æ¯æ—¶é—´
            }
        }

        function goHome() {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-home').classList.add('active');
            document.getElementById('page-title').innerText = 'Ultra Link æ€»æ§åˆ¶å°';
            document.getElementById('btn-back').style.display = 'none';
        }

        // ==========================================
        // 2. å¤šçº¿ç¨‹é€šä¿¡æœºåˆ¶ (Worker)
        // ==========================================
        // ç¡®ä¿ä½ çš„ç›®å½•ä¸‹æœ‰ä¸€ä¸ªå«åš usb-worker.js çš„æ–‡ä»¶ï¼
        const worker = new Worker('usb-worker.js'); 
        let isConnected = false;

        worker.onmessage = (event) => {
            const msg = event.data;

            if (msg.type === 'STATUS') {
                if (msg.data === 'CONNECTED') {
                    document.getElementById('usb-status').innerText = 'ğŸŸ¢ ç¡¬ä»¶å·²è¿æ¥ (å¤šçº¿ç¨‹å°±ç»ª)';
                    document.getElementById('usb-status').style.color = '#00e676';
                    document.getElementById('btn-connect').style.display = 'none';
                    document.getElementById('btn-disconnect').style.display = 'inline-block';
                    isConnected = true;
                } else if (msg.data === 'DISCONNECTED') {
                    document.getElementById('usb-status').innerText = 'â— æœªè¿æ¥';
                    document.getElementById('usb-status').style.color = '#ff5252';
                    document.getElementById('btn-connect').style.display = 'inline-block';
                    document.getElementById('btn-disconnect').style.display = 'none';
                    isConnected = false;
                }
            } 
            else if (msg.type === 'UART1_RX') {
                let ta = document.getElementById('u1-rx');
                ta.value += msg.data;
                ta.scrollTop = ta.scrollHeight; // è‡ªåŠ¨æ»šå±
            }
            else if (msg.type === 'UART2_RX') {
                let ta = document.getElementById('u2-rx');
                ta.value += msg.data;
                ta.scrollTop = ta.scrollHeight;
            }
            else if (msg.type === 'WAVE_DATA') {
                // å°†åå°è§£æå¥½çš„å¤§æ‰¹é‡æ³¢å½¢ç‚¹é˜µå‘ç»™å›¾è¡¨
                updateChartData(msg.data);
            }
        };

        // UI æŒ‰é’®è§¦å‘è¿æ¥è¯·æ±‚
        async function connectUSB() {
            try {
                // å¿…é¡»åœ¨ä¸»çº¿ç¨‹è§¦å‘æˆæƒå¼¹çª—
                await navigator.usb.requestDevice({ filters: [] });
                // æˆæƒåè®© Worker æ¥ç®¡
                worker.postMessage({ cmd: 'CONNECT' });
            } catch (error) {
                console.warn('è¿æ¥å–æ¶ˆæˆ–å¤±è´¥:', error);
            }
        }

        function disconnectUSB() {
            worker.postMessage({ cmd: 'DISCONNECT' });
        }

        // ç»Ÿä¸€å‘åŒ…å‡½æ•°ï¼šå‘Šè¯‰ Worker è¦å‘ç¡¬ä»¶å‘é€ä»€ä¹ˆæŒ‡ä»¤
        function sendCMD(cmdType, payload) {
            if (!isConnected) { alert("è¯·å…ˆè¿æ¥ç¡¬ä»¶ï¼"); return; }
            let packetStr = JSON.stringify({ cmd: cmdType, data: payload });
            const dataBuffer = new TextEncoder().encode(packetStr);
            worker.postMessage({ cmd: 'SEND_DATA', payload: dataBuffer });
        }

        // ==========================================
        // 3. æé€Ÿæ³¢å½¢å›¾æ¸²æŸ“ (uPlot)
        // ==========================================
        const MAX_POINTS = 500; 
        let chartData = [
            Array(MAX_POINTS).fill(0), // Xè½´ç´¢å¼•
            Array(MAX_POINTS).fill(0)  // Yè½´æ•°å€¼
        ];
        for(let i=0; i<MAX_POINTS; i++) chartData[0][i] = i;

        // åˆå§‹åŒ– uPlot é…ç½®
        let opts = {
            width: 800, // åˆå§‹å®½åº¦ï¼Œç¨åä¼šè‡ªåŠ¨ä¿®æ­£
            height: 400,
            axes: [
                { stroke: "#666", grid: { stroke: "#333", width: 1 } },
                { stroke: "#666", grid: { stroke: "#333", width: 1 } }
            ],
            scales: { x: { time: false }, y: { auto: true } },
            series: [
                {}, 
                { stroke: "#ff9800", width: 2 } // Yè½´æ³¢å½¢çº¿é¢œè‰²
            ],
            cursor: { sync: { key: "scope" } } 
        };

        const chartDiv = document.getElementById("chart-container");
        const uplot = new uPlot(opts, chartData, chartDiv);
        let totalPointsReceived = 0;

        // æ›´æ–°æ³¢å½¢æ ¸å¿ƒå‡½æ•° (ä½¿ç”¨æ»šåŠ¨æ•°ç»„ç­–ç•¥)
        function updateChartData(newPointsArray) {
            totalPointsReceived += newPointsArray.length;
            
            for(let i=0; i<newPointsArray.length; i++) {
                chartData[1].push(newPointsArray[i]); // å°¾éƒ¨æ¨å…¥æ–°ç‚¹
                chartData[1].shift();                 // å¤´éƒ¨è¸¢å‡ºè€ç‚¹
            }
            uplot.setData(chartData); // æé€Ÿé‡ç»˜
        }

        // æ¯ç§’ç»Ÿè®¡ä¸€æ¬¡é‡‡æ ·ç‡
        setInterval(() => {
            document.getElementById('fps-counter').innerText = totalPointsReceived;
            totalPointsReceived = 0;
        }, 1000);

        function clearChart() {
            chartData[1].fill(0);
            uplot.setData(chartData);
        }

        // çª—å£å¤§å°å˜åŒ–æ—¶è‡ªé€‚åº”å›¾è¡¨å°ºå¯¸
        window.addEventListener("resize", () => {
            if(document.getElementById('page-scope').classList.contains('active')) {
                uplot.setSize({ width: chartDiv.clientWidth, height: chartDiv.clientHeight });
            }
        });
    </script>
</body>
</html>
