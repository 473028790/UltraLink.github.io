<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Ultra Link å¤šåŠŸèƒ½è°ƒè¯•ç»ˆç«¯</title>
    <link rel="stylesheet" href="https://unpkg.com/uplot/dist/uPlot.min.css">
    <script src="https://unpkg.com/uplot/dist/uPlot.iife.min.js"></script>
    
    <style>
        :root { --bg: #1e1e1e; --panel: #2d2d2d; --primary: #007acc; --text: #eaeaea; --danger: #cc3300; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .topbar { background: #111; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 10; }
        .topbar h2 { margin: 0; font-size: 1.2rem; color: #4fc3f7; }
        button { background: var(--primary); color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px; font-size: 14px; transition: 0.2s; }
        button:hover { background: #005f9e; }
        button.danger { background: var(--danger); }
        button.danger:hover { background: #990000; }
        button.back-btn { background: #555; margin-right: 15px; }
        button.back-btn:hover { background: #777; }

        /* é¡µé¢å®¹å™¨ä¸åˆ‡æ¢åŠ¨ç”» */
        .view-container { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 15px; }
        .page { display: none; animation: fadeIn 0.3s ease; flex: 1; flex-direction: column; height: 100%; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ä¸»é¡µç½‘æ ¼èœå• */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; max-width: 1000px; margin: 20px auto; width: 100%; }
        .menu-card { background: var(--panel); border: 1px solid #444; border-radius: 12px; padding: 30px 20px; text-align: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 8px 15px rgba(0,122,204,0.3); }
        .menu-card h3 { margin: 0 0 10px 0; font-size: 1.4rem; color: #fff; }
        .menu-card p { margin: 0; color: #aaa; font-size: 0.9rem; }

        /* é€šç”¨æ§ä»¶æ ·å¼ */
        .panel { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .control-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; }
        .control-row { display: flex; align-items: center; gap: 10px; width: 100%; }
        input, select { background: #111; border: 1px solid #555; color: #0f0; padding: 8px; border-radius: 4px; font-family: monospace; width: 100%; box-sizing: border-box; }
        input:focus { outline: none; border-color: var(--primary); }
        textarea { flex: 1; width: 100%; background: #000; color: #0f0; border: 1px solid #555; padding: 10px; box-sizing: border-box; font-family: 'Consolas', monospace; resize: none; border-radius: 4px; }
        
        /* åˆ‡æ¢æŒ‰é’®ç»„ (Hex/ASCII) */
        .toggle-group { display: flex; background: #111; border-radius: 4px; overflow: hidden; border: 1px solid #555; }
        .toggle-btn { flex: 1; background: transparent; color: #aaa; border: none; padding: 6px 0; cursor: pointer; font-size: 12px; border-radius: 0; }
        .toggle-btn.active { background: var(--primary); color: white; font-weight: bold; }

        /* ================= VOFA+ ä¸“å±å¸ƒå±€ ================= */
        .vofa-layout { display: flex; gap: 15px; height: 100%; width: 100%; }
        /* å·¦ä¾§è¾¹æ  (å®šå®½) */
        .vofa-sidebar { width: 260px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
        /* å³ä¾§ä¸»åŒº (è‡ªé€‚åº”å¡«æ»¡) */
        .vofa-main { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 0; }
        /* å³ä¸Šï¼šæ³¢å½¢åŒº */
        .vofa-scope { flex: 3; display: flex; flex-direction: column; min-height: 200px; }
        /* å³ä¸‹ï¼šæ¥æ”¶åŒº */
        .vofa-rx { flex: 2; display: flex; flex-direction: column; min-height: 150px; }
        
        .section-title { font-size: 13px; color: #4fc3f7; margin: 0 0 10px 0; border-bottom: 1px solid #444; padding-bottom: 5px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="topbar">
        <div style="display: flex; align-items: center;">
            <button id="btn-back" class="back-btn" style="display: none;" onclick="goHome()">â—€ è¿”å›ä¸»é¡µ</button>
            <h2 id="page-title">Ultra Link æ€»æ§åˆ¶å°</h2>
        </div>
        <div>
            <span id="usb-status" style="color: #ff5252; margin-right: 15px; font-weight: bold;">â— æœªè¿æ¥ (Workerä¼‘çœ )</span>
            <button id="btn-connect" onclick="connectUSB()">è¿æ¥ç¡¬ä»¶</button>
            <button id="btn-disconnect" class="danger" onclick="disconnectUSB()" style="display:none;">æ–­å¼€è¿æ¥</button>
        </div>
    </div>

    <div class="view-container">
        
        <div id="page-home" class="page active">
            <div class="menu-grid">
                <div class="menu-card" onclick="navTo('page-uart1', 'UART 1 ç»¼åˆæ§åˆ¶å° (Vofa+ æ¨¡å¼)')" style="border-color: #ff9800;">
                    <h3 style="color: #ff9800;">ğŸ“ˆ UART 1 / ç¤ºæ³¢å™¨</h3><p>ä¸²å£é…ç½® / æ³¢å½¢æ¸²æŸ“ / Hexè§†å›¾</p>
                </div>
                <div class="menu-card" onclick="navTo('page-uart2', 'UART 2 è°ƒè¯•ç»ˆç«¯')">
                    <h3>ğŸ“Ÿ UART 2</h3><p>è¾…åŠ©å¤–è®¾ç›‘æ§ä¸²å£</p>
                </div>
                <div class="menu-card" onclick="navTo('page-can', 'CAN æ€»çº¿åˆ†æä»ª')">
                    <h3>ğŸšŒ CAN Bus</h3><p>æŠ¥æ–‡æ”¶å‘ / æ ‡å‡†/æ‰©å±•å¸§</p>
                </div>
                <div class="menu-card" onclick="navTo('page-i2c', 'I2C å¯„å­˜å™¨è°ƒè¯•')">
                    <h3>ğŸ”Œ I2C Master</h3><p>è®¾å¤‡æ‰«æ / å¯„å­˜å™¨è¯»å†™</p>
                </div>
                <div class="menu-card" onclick="navTo('page-analog', 'æ¨¡æ‹Ÿé‡ä¸å¤–è®¾ (PWM/DAC)')">
                    <h3>âš¡ PWM / DAC</h3><p>å ç©ºæ¯”è°ƒèŠ‚ / æ¨¡æ‹Ÿç”µå‹è¾“å‡º</p>
                </div>
            </div>
        </div>

        <div id="page-uart1" class="page">
            <div class="vofa-layout">
                
                <div class="vofa-sidebar">
                    <div class="panel" style="flex: none;">
                        <h3 class="section-title">âš™ï¸ ä¸²å£é…ç½®</h3>
                        <div class="control-row" style="margin-bottom: 10px;">
                            <span style="font-size: 13px; width: 60px;">æ³¢ç‰¹ç‡</span>
                            <select id="u1-baud">
                                <option value="9600">9600</option>
                                <option value="115200" selected>115200</option>
                                <option value="2000000">2000000</option>
                            </select>
                        </div>
                        <button onclick="sendCMD('CFG_U1', document.getElementById('u1-baud').value)" style="width: 100%;">åº”ç”¨é…ç½®</button>
                    </div>

                    <div class="panel" style="flex: none;">
                        <h3 class="section-title">ğŸ“¥ æ¥æ”¶è®¾ç½®</h3>
                        <div class="toggle-group" style="margin-bottom: 10px;">
                            <button id="rx-ascii" class="toggle-btn active" onclick="setRxMode('ascii')">å­—ç¬¦ (ASCII)</button>
                            <button id="rx-hex" class="toggle-btn" onclick="setRxMode('hex')">åå…­è¿›åˆ¶ (HEX)</button>
                        </div>
                        <button class="danger" onclick="document.getElementById('u1-rx').value=''" style="width: 100%;">æ¸…ç©ºæ¥æ”¶åŒº</button>
                    </div>

                    <div class="panel" style="flex: 1; display: flex; flex-direction: column;">
                        <h3 class="section-title">ğŸ“¤ å‘é€åŒº</h3>
                        <div class="toggle-group" style="margin-bottom: 10px;">
                            <button class="toggle-btn active">å­—ç¬¦å‘é€</button>
                            <button class="toggle-btn">HEX å‘é€</button>
                        </div>
                        <textarea id="u1-tx" placeholder="è¾“å…¥è¦å‘é€çš„æ•°æ®..." style="flex: 1; margin-bottom: 10px; color: #fff;"></textarea>
                        <button onclick="sendCMD('TX_U1', document.getElementById('u1-tx').value)" style="width: 100%; background: #28a745;">ä¸€é”®å‘é€</button>
                    </div>
                </div>

                <div class="vofa-main">
                    
                    <div class="panel vofa-scope">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 class="section-title" style="margin: 0; border: none;">ğŸ“ˆ å®æ—¶æ•°æ®æ³¢å½¢</h3>
                            <div style="font-size: 12px; color: #888;">
                                é‡‡æ ·ç‡: <span id="fps-counter" style="color:#00e676; font-weight: bold;">0</span> pts/s 
                                <button class="danger" style="padding: 2px 8px; margin-left: 10px; font-size: 11px;" onclick="clearChart()">æ¸…ç©ºæ³¢å½¢</button>
                            </div>
                        </div>
                        <div id="chart-container" style="flex: 1; background: #000; border-radius: 4px; border: 1px solid #444; width: 100%; overflow: hidden;"></div>
                    </div>

                    <div class="panel vofa-rx">
                        <h3 class="section-title">ğŸ“„ è¯¦ç»†æ•°æ®æ—¥å¿—</h3>
                        <textarea id="u1-rx" readonly placeholder="ç­‰å¾…å¤šçº¿ç¨‹æ¥æ”¶æ•°æ®..."></textarea>
                    </div>
                    
                </div>
            </div>
        </div>

        <div id="page-uart2" class="page">
            <div class="panel">
                <h3 class="section-title">UART 2 ç›‘æ§åŒº</h3>
                <textarea id="u2-rx" readonly placeholder="ç­‰å¾…æ¥æ”¶ UART2 æ•°æ®..."></textarea>
                <div class="control-group" style="margin-top: 15px; flex-direction: row;">
                    <input type="text" id="u2-tx" placeholder="è¾“å…¥è¦å‘é€çš„å†…å®¹..." style="flex: 1;">
                    <button onclick="sendCMD('TX_U2', document.getElementById('u2-tx').value)">å‘é€</button>
                    <button class="danger" onclick="document.getElementById('u2-rx').value=''">æ¸…ç©º</button>
                </div>
            </div>
        </div>

        <div id="page-can" class="page">
            <div class="panel">
                <h3 class="section-title">å‘é€ CAN æŠ¥æ–‡</h3>
                <div class="control-row" style="margin-bottom: 15px;">
                    <select id="can-type" style="width: auto;"><option value="STD">æ ‡å‡†å¸§</option><option value="EXT">æ‰©å±•å¸§</option></select>
                    ID (Hex): <input type="text" id="can-id" placeholder="123" style="width: 100px;">
                    Data (Hex): <input type="text" id="can-data" placeholder="11 22 33 44 55 66 77 88" style="flex: 1;">
                    <button onclick="sendCMD('CAN_TX', document.getElementById('can-id').value + '|' + document.getElementById('can-data').value)">å‘é€æŠ¥æ–‡</button>
                </div>
                <h3 class="section-title">æ¥æ”¶è®°å½•</h3>
                <textarea id="can-rx" readonly placeholder="CAN æ€»çº¿æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            </div>
        </div>

        <div id="page-i2c" class="page">
            <div class="panel">
                <h3 class="section-title">I2C Master æ“ä½œ</h3>
                <div class="control-row" style="margin-bottom: 15px;">
                    Addr(Hex): <input type="text" id="i2c-addr" placeholder="50" style="width: 80px;">
                    Reg(Hex): <input type="text" id="i2c-reg" placeholder="00" style="width: 80px;">
                    <button onclick="sendCMD('I2C_READ', '')" style="background: #28a745;">è¯»å–æ•°æ®</button>
                </div>
                <div class="control-row" style="margin-bottom: 15px;">
                    å†™å…¥æ•°æ®: <input type="text" id="i2c-write-data" placeholder="FF" style="flex: 1;">
                    <button onclick="sendCMD('I2C_WRITE', '')" class="danger">å†™å…¥å¯„å­˜å™¨</button>
                </div>
                <textarea id="i2c-log" readonly placeholder="æ“ä½œæ—¥å¿—..."></textarea>
            </div>
        </div>

        <div id="page-analog" class="page">
            <div class="panel" style="flex: none; margin-bottom: 15px;">
                <h3 class="section-title">PWM è¾“å‡ºé…ç½®</h3>
                <div class="control-row" style="margin-bottom: 15px;">
                    é¢‘ç‡(Hz): <input type="number" id="pwm-freq" value="1000" style="width: 100px;">
                    <button onclick="sendCMD('PWM_FREQ', document.getElementById('pwm-freq').value)">åº”ç”¨é¢‘ç‡</button>
                </div>
                <div class="control-row">
                    å ç©ºæ¯”: <input type="range" id="pwm-duty" min="0" max="100" value="50" style="flex: 1;" oninput="document.getElementById('pwm-val').innerText = this.value + '%'">
                    <span id="pwm-val" style="width: 50px; color: #0f0; text-align: right;">50%</span>
                    <button onclick="sendCMD('PWM_DUTY', document.getElementById('pwm-duty').value)">è°ƒèŠ‚</button>
                </div>
            </div>
            <div class="panel" style="flex: none;">
                <h3 class="section-title">DAC æ¨¡æ‹Ÿé‡è¾“å‡º</h3>
                <div class="control-row">
                    ç”µå‹(mV): <input type="number" id="dac-mv" value="1500" min="0" max="3300" style="width: 100px;">
                    <button onclick="sendCMD('DAC_OUT', document.getElementById('dac-mv').value)">è¾“å‡º</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // 1. é¡µé¢è·¯ç”±ä¸ UI åˆ‡æ¢é€»è¾‘
        // ==========================================
        function navTo(pageId, title) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.getElementById('page-title').innerText = title;
            document.getElementById('btn-back').style.display = 'inline-block';

            // å½“è¿›å…¥ UART1 (æ³¢å½¢é¡µ) æ—¶ï¼Œå»¶è¿Ÿé‡ç½®å›¾è¡¨å°ºå¯¸ä»¥é€‚åº”å³ä¾§å¸ƒå±€
            if(pageId === 'page-uart1') {
                setTimeout(resizeChart, 50);
            }
        }

        function goHome() {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-home').classList.add('active');
            document.getElementById('page-title').innerText = 'Ultra Link æ€»æ§åˆ¶å°';
            document.getElementById('btn-back').style.display = 'none';
        }

        // ==========================================
        // 2. HEX/ASCII æ˜¾ç¤ºåˆ‡æ¢é€»è¾‘
        // ==========================================
        let rxMode = 'ascii'; // é»˜è®¤å­—ç¬¦æ¨¡å¼
        function setRxMode(mode) {
            rxMode = mode;
            // åˆ‡æ¢æŒ‰é’®é«˜äº®çŠ¶æ€
            document.getElementById('rx-ascii').classList.remove('active');
            document.getElementById('rx-hex').classList.remove('active');
            document.getElementById('rx-' + mode).classList.add('active');
            // æ¸…ç©ºå±å¹•ä»¥é¿å…ä¹±ç æ··åˆ
            document.getElementById('u1-rx').value = `--- å·²åˆ‡æ¢ä¸º ${mode.toUpperCase()} æ˜¾ç¤ºæ¨¡å¼ ---\n`;
        }

        // ç®€å•çš„å­—ç¬¦ä¸²è½¬ Hex æ¨¡æ‹Ÿå‡½æ•° (å®é™…ä¸Š Worker åº”è¯¥ç›´æ¥å‘ Uint8Arrayï¼Œè¿™é‡Œåšæ¼”ç¤ºå¤„ç†)
        function stringToHexStr(str) {
            let hex = '';
            for(let i=0; i<str.length; i++) {
                hex += str.charCodeAt(i).toString(16).padStart(2, '0').toUpperCase() + ' ';
            }
            return hex;
        }

        // ==========================================
        // 3. å¤šçº¿ç¨‹é€šä¿¡æœºåˆ¶ (Worker)
        // ==========================================
        const worker = new Worker('usb-worker.js'); 
        let isConnected = false;

        worker.onmessage = (event) => {
            const msg = event.data;

            if (msg.type === 'STATUS') {
                if (msg.data === 'CONNECTED') {
                    document.getElementById('usb-status').innerText = 'ğŸŸ¢ ç¡¬ä»¶å·²è¿æ¥';
                    document.getElementById('usb-status').style.color = '#00e676';
                    document.getElementById('btn-connect').style.display = 'none';
                    document.getElementById('btn-disconnect').style.display = 'inline-block';
                    isConnected = true;
                } else if (msg.data === 'DISCONNECTED') {
                    document.getElementById('usb-status').innerText = 'â— æœªè¿æ¥';
                    document.getElementById('usb-status').style.color = '#ff5252';
                    document.getElementById('btn-connect').style.display = 'inline-block';
                    document.getElementById('btn-disconnect').style.display = 'none';
                    isConnected = false;
                }
            } 
            else if (msg.type === 'UART1_RX') {
                let ta = document.getElementById('u1-rx');
                // æ ¹æ®å½“å‰æ¨¡å¼å†³å®šæ˜¾ç¤ºå­—ç¬¦è¿˜æ˜¯ HEX
                if (rxMode === 'hex') {
                    ta.value += stringToHexStr(msg.data);
                } else {
                    ta.value += msg.data;
                }
                ta.scrollTop = ta.scrollHeight; // æ»šå±
            }
            else if (msg.type === 'WAVE_DATA') {
                updateChartData(msg.data);
            }
        };

        async function connectUSB() {
            try {
                await navigator.usb.requestDevice({ filters: [] });
                worker.postMessage({ cmd: 'CONNECT' });
            } catch (error) { console.warn('è¿æ¥å–æ¶ˆ'); }
        }

        function disconnectUSB() { worker.postMessage({ cmd: 'DISCONNECT' }); }

        function sendCMD(cmdType, payload) {
            if (!isConnected) { alert("è¯·å…ˆè¿æ¥ç¡¬ä»¶ï¼"); return; }
            let packetStr = JSON.stringify({ cmd: cmdType, data: payload });
            worker.postMessage({ cmd: 'SEND_DATA', payload: new TextEncoder().encode(packetStr) });
        }

        // ==========================================
        // 4. æé€Ÿæ³¢å½¢å›¾æ¸²æŸ“ (uPlot)
        // ==========================================
        const MAX_POINTS = 500; 
        let chartData = [ Array(MAX_POINTS).fill(0), Array(MAX_POINTS).fill(0) ];
        for(let i=0; i<MAX_POINTS; i++) chartData[0][i] = i;

        const chartDiv = document.getElementById("chart-container");
        
        // åˆå§‹é…ç½®ï¼Œå°ºå¯¸ä¼šåœ¨ resizeChart ä¸­è¢«é‡å†™
        let opts = {
            width: 500, height: 200,
            axes: [
                { stroke: "#666", grid: { stroke: "#333", width: 1 } },
                { stroke: "#666", grid: { stroke: "#333", width: 1 } }
            ],
            scales: { x: { time: false }, y: { auto: true } },
            series: [ {}, { stroke: "#ff9800", width: 2 } ],
            cursor: { sync: { key: "scope" } } 
        };

        const uplot = new uPlot(opts, chartData, chartDiv);
        let totalPointsReceived = 0;

        function updateChartData(newPointsArray) {
            totalPointsReceived += newPointsArray.length;
            for(let i=0; i<newPointsArray.length; i++) {
                chartData[1].push(newPointsArray[i]);
                chartData[1].shift();
            }
            uplot.setData(chartData);
        }

        setInterval(() => {
            document.getElementById('fps-counter').innerText = totalPointsReceived;
            totalPointsReceived = 0;
        }, 1000);

        function clearChart() {
            chartData[1].fill(0);
            uplot.setData(chartData);
        }

        // è‡ªé€‚åº”å›¾è¡¨å°ºå¯¸çš„å‡½æ•°
        function resizeChart() {
            if(document.getElementById('page-uart1').classList.contains('active')) {
                uplot.setSize({ width: chartDiv.clientWidth, height: chartDiv.clientHeight });
            }
        }
        window.addEventListener("resize", resizeChart);
    </script>
</body>
</html>
