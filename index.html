<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Ultra Link å¤šåŠŸèƒ½è°ƒè¯•ç»ˆç«¯</title>
  <link rel="stylesheet" href="https://unpkg.com/uplot/dist/uPlot.min.css">
  <script src="https://unpkg.com/uplot/dist/uPlot.iife.min.js"></script>

  <style>
      :root { --bg: #1e1e1e; --panel: #2d2d2d; --primary: #007acc; --text: #eaeaea; --danger: #cc3300; }
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

      /* é¡¶éƒ¨çŠ¶æ€æ  */
      .topbar { background: #111; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 10; }
      .topbar h2 { margin: 0; font-size: 1.2rem; color: #4fc3f7; }
      button { background: var(--primary); color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px; font-size: 14px; transition: 0.2s; }
      button:hover { background: #005f9e; }
      button.danger { background: var(--danger); }
      button.danger:hover { background: #990000; }
      button.back-btn { background: #555; margin-right: 15px; }
      button.back-btn:hover { background: #777; }

      /* é¡µé¢å®¹å™¨ä¸åˆ‡æ¢åŠ¨ç”» */
      .view-container { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 15px; }
      .page { display: none; animation: fadeIn 0.3s ease; flex: 1; flex-direction: column; height: 100%; overflow: hidden;}
      .page.active { display: flex; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      /* ä¸»é¡µç½‘æ ¼èœå• */
      .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; max-width: 1000px; margin: 20px auto; width: 100%; overflow-y: auto; padding-bottom: 20px;}
      .menu-card { background: var(--panel); border: 1px solid #444; border-radius: 12px; padding: 30px 20px; text-align: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
      .menu-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 8px 15px rgba(0,122,204,0.3); }
      .menu-card h3 { margin: 0 0 10px 0; font-size: 1.4rem; color: #fff; }
      .menu-card p { margin: 0; color: #aaa; font-size: 0.9rem; }

      /* é€šç”¨æ§ä»¶æ ·å¼ */
      .panel { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #444; }
      .control-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; }
      .control-row { display: flex; align-items: center; gap: 10px; width: 100%; margin-bottom: 8px; }
      .control-row:last-child { margin-bottom: 0; }

      input[type="text"], input[type="number"], select { background: #111; border: 1px solid #555; color: #0f0; padding: 6px; border-radius: 4px; font-family: monospace; width: 100%; box-sizing: border-box; font-size: 13px; }
      input:focus, select:focus { outline: none; border-color: var(--primary); }
      textarea { flex: 1; width: 100%; background: #000; color: #0f0; border: 1px solid #555; padding: 10px; box-sizing: border-box; font-family: 'Consolas', monospace; resize: none; border-radius: 4px; }

      .toggle-group { display: flex; background: #111; border-radius: 4px; overflow: hidden; border: 1px solid #555; }
      .toggle-btn { flex: 1; background: transparent; color: #aaa; border: none; padding: 6px 0; cursor: pointer; font-size: 12px; border-radius: 0; }
      .toggle-btn.active { background: var(--primary); color: white; font-weight: bold; }

      /* VOFA+ å¸ƒå±€ */
      .vofa-layout { display: flex; gap: 15px; height: 100%; width: 100%; }
      .vofa-sidebar { width: 270px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; overflow-y: auto; padding-right: 5px; }
      .vofa-sidebar::-webkit-scrollbar { width: 6px; }
      .vofa-sidebar::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
      .vofa-main { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 0; }
      .vofa-scope { flex: 3; display: flex; flex-direction: column; min-height: 200px; }
      .vofa-rx { flex: 2; display: flex; flex-direction: column; min-height: 150px; }
      .section-title { font-size: 13px; color: #4fc3f7; margin: 0 0 10px 0; border-bottom: 1px solid #444; padding-bottom: 5px; font-weight: bold; text-transform: uppercase; }
      .cfg-label { font-size: 12px; width: 60px; color: #aaa; flex-shrink: 0; }

      /* ================= DAP ä¸“å±ä»¿ç”Ÿå¸ƒå±€ ================= */
      fieldset { border: 1px solid #555; border-radius: 6px; padding: 10px; margin-bottom: 10px; }
      legend { font-size: 12px; color: #aaa; padding: 0 5px; }
      .dap-radio-group label { display: block; font-size: 13px; margin-bottom: 5px; color: #ccc; cursor: pointer;}
      .dap-btn-group { display: flex; gap: 10px; }
      .dap-btn-group button { flex: 1; background: #444; color: #ddd; }
      .dap-btn-group button:hover { background: #555; }

      .dap-toolbar { display: flex; gap: 10px; padding: 10px; background: #222; border: 1px solid #444; border-radius: 6px; margin-bottom: 10px; align-items: center; overflow-x: auto;}
      .dap-toolbar button { background: #333; color: #ddd; border: 1px solid #555; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 15px; font-size: 12px; min-width: 60px;}
      .dap-toolbar button:hover { background: #444; border-color: var(--primary); color: white;}
      .dap-toolbar button span { font-size: 18px; margin-bottom: 5px; }

      .dap-main-tabs { display: flex; border-bottom: 2px solid #444; margin-bottom: 15px; }
      .dap-main-tab { padding: 10px 20px; cursor: pointer; font-size: 14px; font-weight: bold; color: #888; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: 0.2s;}
      .dap-main-tab:hover { color: #fff; }
      .dap-main-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

      .dap-sub-page { display: none; height: 100%; overflow: hidden;}
      .dap-sub-page.active { display: flex; flex-direction: column; }

      .ob-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
      .ob-table th, .ob-table td { border: 1px solid #444; padding: 8px; }
      .ob-table th { background: #222; color: #4fc3f7; }
      .ob-table tr:nth-child(even) { background: #2a2a2a; }

      .hex-viewer { width: 100%; border-collapse: collapse; font-family: 'Consolas', monospace; font-size: 13px; }
      .hex-viewer th, .hex-viewer td { border: 1px solid #444; padding: 4px; text-align: center; }
      .hex-viewer th { background: #222; color: #ff9800; position: sticky; top: 0; z-index: 2;}
      .hex-viewer .addr-col { background: #222; color: #4fc3f7; font-weight: bold; text-align: left; padding-left: 10px; position: sticky; left: 0; z-index: 1;}
      .hex-viewer td { color: #0f0; }
      .hex-viewer td:hover { background: #007acc; color: white; cursor: crosshair;}

      /* ================= èŠ¯ç‰‡é€‰æ‹©å¼¹çª— Modal ================= */
      .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; align-items: center; justify-content: center; }
      .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
      .modal-box { background: #efefef; color: #333; width: 700px; max-width: 95%; border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
      .modal-header { background: #fff; padding: 10px 15px; font-size: 14px; font-weight: bold; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
      .modal-header span { color: #333; }
      .modal-close { cursor: pointer; font-size: 18px; color: #888; }
      .modal-close:hover { color: #d00; }
      .modal-body { display: flex; padding: 10px; gap: 10px; height: 350px; background: #f5f5f5; }
      .modal-col { flex: 1; background: #fff; border: 1px solid #ccc; display: flex; flex-direction: column; }
      .modal-col-title { font-size: 12px; padding: 5px 10px; background: #e0e0e0; border-bottom: 1px solid #ccc; color: #333; font-weight: bold;}
      .modal-list { flex: 1; overflow-y: auto; list-style: none; margin: 0; padding: 0; }
      .modal-list li { padding: 6px 10px; font-size: 12px; cursor: pointer; color: #000; border-bottom: 1px solid #eee; }
      .modal-list li:hover { background: #e6f7ff; }
      .modal-list li.active { background: #0078d7; color: white; }
      .modal-footer { background: #fff; padding: 10px 15px; border-top: 1px solid #ccc; display: flex; align-items: center; gap: 10px; font-size: 12px; }
      .modal-footer input[type="text"] { background: #fff; border: 1px solid #aaa; color: #000; padding: 4px 8px; flex: 1; }
      .modal-footer .btn { padding: 5px 15px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; background: #f0f0f0; color: #333; font-size: 12px; }
      .modal-footer .btn:hover { background: #e0e0e0; }
      .modal-footer .btn-ok { background: #fff; border: 1px solid #28a745; color: #28a745; display: flex; align-items: center; gap: 5px; }
      .modal-footer .btn-ok:hover { background: #28a745; color: white; }
      .modal-footer .btn-cancel { background: #fff; border: 1px solid #dc3545; color: #dc3545; display: flex; align-items: center; gap: 5px; }
      .modal-footer .btn-cancel:hover { background: #dc3545; color: white; }

      /* ================= ç³»ç»Ÿè®¾ç½® ================= */
      .sys-layout { display: flex; height: 100%; background: var(--panel); border-radius: 8px; border: 1px solid #444; overflow: hidden; }
      .sys-sidebar { width: 200px; background: #222; border-right: 1px solid #444; }
      .sys-menu-item { padding: 15px 20px; font-size: 14px; color: #ccc; cursor: pointer; border-bottom: 1px solid #333; transition: 0.2s; }
      .sys-menu-item:hover { background: #333; }
      .sys-menu-item.active { background: var(--primary); color: #fff; border-left: 4px solid #4fc3f7; }
      .sys-content { flex: 1; padding: 30px; overflow-y: auto; }
      .sys-section { display: none; }
      .sys-section.active { display: block; animation: fadeIn 0.2s; }

      .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
      .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: var(--primary); }
      input:checked + .slider:before { transform: translateX(20px); }

      /* ================= uPlot è‡ªå®šä¹‰æ‚¬æµ®æ•°æ®æç¤ºæ¡† ================= */
      .u-tooltip {
          position: absolute;
          background: rgba(30, 30, 30, 0.9);
          color: #fff;
          padding: 6px 10px;
          border-radius: 6px;
          font-size: 12px;
          pointer-events: none;
          z-index: 100;
          border: 1px solid #555;
          white-space: nowrap;
          box-shadow: 0 4px 10px rgba(0,0,0,0.5);
          display: none; /* é»˜è®¤éšè— */
          font-family: Consolas, monospace;
      }
      .u-tooltip .val { color: #0f0; font-weight: bold; font-size: 14px; }
  </style>
</head>
<body>

<div class="topbar">
  <div style="display: flex; align-items: center;">
    <button id="btn-back" class="back-btn" style="display: none;" onclick="goHome()">â—€ è¿”å›ä¸»é¡µ</button>
    <h2 id="page-title">Ultra Link æ€»æ§åˆ¶å°</h2>
  </div>
  <div>
    <span id="usb-status" style="color: #ff5252; margin-right: 15px; font-weight: bold;">â— æœªè¿æ¥ (è¯·è¿æ¥DAP)</span>
    <button id="btn-connect" onclick="connectUSB()">è¿æ¥ç¡¬ä»¶</button>
    <button id="btn-disconnect" class="danger" onclick="disconnectUSB()" style="display:none;">æ–­å¼€è¿æ¥</button>
  </div>
</div>

<div class="view-container">

  <div id="page-home" class="page active">
    <div class="menu-grid">
      <div class="menu-card" onclick="navTo('page-dap', 'DAP ç»¼åˆæ§åˆ¶å°')" >
        <h3 >âœ¨ DAP</h3><p>DAPçƒ§å½•ä¸é…ç½®</p>
      </div>
      <div class="menu-card" onclick="navTo('page-uart1', 'UART 1 ç»¼åˆæ§åˆ¶å°')" >
        <h3 >ğŸ“Ÿ UART 1</h3><p>ä¸²å£é€šä¿¡ / æ³¢å½¢æ¸²æŸ“</p>
      </div>
      <div class="menu-card" onclick="navTo('page-uart2', 'UART 2 ç»¼åˆæ§åˆ¶å°')" >
        <h3 >ğŸ“Ÿ UART 2</h3><p>ä¸²å£é€šä¿¡ / æ³¢å½¢æ¸²æŸ“</p>
      </div>
      <div class="menu-card" onclick="navTo('page-can', 'CAN æ€»çº¿åˆ†æä»ª')">
        <h3>ğŸšŒ CAN Bus</h3><p>æŠ¥æ–‡æ”¶å‘ / æ ‡å‡†å¸§</p>
      </div>
      <div class="menu-card" onclick="navTo('page-i2c', 'I2C å¯„å­˜å™¨è°ƒè¯•')">
        <h3>ğŸ”Œ I2C Master</h3><p>è®¾å¤‡æ‰«æ / å¯„å­˜å™¨è¯»å†™</p>
      </div>
      <div class="menu-card" onclick="navTo('page-pwm', 'PWM è¾“å‡ºæ§åˆ¶')">
        <h3>âš¡ PWM</h3><p>æ³¢å½¢ / å ç©ºæ¯”è°ƒæ•´</p>
      </div>
      <div class="menu-card" onclick="navTo('page-dac', 'DAC æ¨¡æ‹Ÿè¾“å‡º')">
        <h3>âš¡ DAC</h3><p>æ³¢å½¢ / é¢‘ç‡ä¸åç½®</p>
      </div>
      <div class="menu-card" onclick="navTo('page-sysset', 'ç³»ç»Ÿè®¾ç½®')">
        <h3>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3><p>ä¸»é¢˜ / éŸ³è‰² / åå¥½è®¾ç½®</p>
      </div>
    </div>
  </div>

  <div id="page-dap" class="page">

    <div class="dap-toolbar">
      <button onclick="dapAction('erase')"><span>ğŸ—‘ï¸</span>æ“¦é™¤</button>
      <button onclick="dapAction('read')"><span>ğŸ“¥</span>è¯»å–</button>
      <button onclick="dapAction('write')"><span>ğŸ“¤</span>å†™å…¥</button>
      <button onclick="dapAction('verify')"><span>âœ…</span>æ ¡éªŒ</button>
      <button onclick="dapAction('auto')" style="border-color: #007acc; color: #4fc3f7;"><span>âš¡</span>è‡ªåŠ¨</button>
      <button onclick="dapAction('reset')"><span>ğŸ”„</span>å¤ä½</button>
      <button onclick="dapAction('readid')"><span>ğŸ†”</span>è¯»ID</button>
      <button onclick="dapAction('blank')"><span>ğŸ”</span>æŸ¥ç©º</button>
    </div>

    <div class="dap-main-tabs">
      <div class="dap-main-tab active" onclick="switchDapTab('dap-prog', this)">çƒ§å½•å™¨è®¾ç½®</div>
      <div class="dap-main-tab" onclick="switchDapTab('dap-ob', this)">é€‰é¡¹å­—èŠ‚</div>
      <div class="dap-main-tab" onclick="switchDapTab('dap-flash', this)">Program Memory</div>
    </div>

    <div id="dap-prog" class="dap-sub-page active">
      <div style="display: flex; gap: 20px; height: 100%;">
        <div style="flex: 1.2; display: flex; flex-direction: column; overflow-y: auto; padding-right: 5px;">

          <fieldset>
            <legend>èŠ¯ç‰‡è®¾ç½®</legend>
            <div class="control-row">
              <span class="cfg-label" style="width:50px;">MCU:</span>
              <input type="text" id="dap-mcu" placeholder="è¯·é€‰æ‹©èŠ¯ç‰‡" readonly style="background:#222; color:#fff;">
              <label style="font-size: 12px; margin-left: 10px;"><input type="checkbox"> è®¾å¤‡ä¸Šéšè—</label>
              <div class="dap-btn-group" style="margin-left: auto;">
                <button onclick="openChipSelector()" style="background: #e0e0e0; color: #000; border:1px solid #ccc; display:flex; align-items:center; gap:5px;"><span>âš™ï¸</span> é€‰æ‹©èŠ¯ç‰‡</button>
                <button style="background: #28a745; color: white;">âœ” åº”ç”¨è®¾ç½®</button>
              </div>
            </div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">Flashå®¹é‡: <span style="color:#0f0;" id="dap-flash-size">1024 KB</span></div>
          </fieldset>

          <div style="display: flex; gap: 10px;">
            <fieldset style="flex: 1;">
              <legend>æ“¦é™¤æ–¹å¼</legend>
              <div class="dap-radio-group">
                <label><input type="radio" name="dap-erase" value="none"> ä¸æ“¦é™¤</label>
                <label><input type="radio" name="dap-erase" value="all" checked> å…¨ç‰‡æ“¦é™¤</label>
                <label><input type="radio" name="dap-erase" value="page"> é¡µé¢æ“¦é™¤</label>
              </div>
            </fieldset>

            <fieldset style="flex: 1;">
              <legend>æ¥å£ç”µå¹³</legend>
              <div class="dap-radio-group">
                <label><input type="radio" name="dap-volt" value="3.3v" checked> 3.3V</label>
                <label><input type="radio" name="dap-volt" value="5.0v"> 5.0V</label>
              </div>
            </fieldset>

            <fieldset style="flex: 2;">
              <legend>å…¶ä»–</legend>
              <div class="control-row" style="margin-bottom: 5px;">
                <span class="cfg-label" style="width:60px;">ç¼–ç¨‹é€Ÿåº¦</span>
                <select><option>10M hz</option><option>5M hz</option><option>1M hz</option></select>
              </div>
              <div class="control-row" style="margin-bottom: 10px;">
                <span class="cfg-label" style="width:60px;">é€‰é¡¹å­—æ¨¡å¼</span>
                <select><option>æ¢å¤é»˜è®¤=>ç”¨æˆ·è®¾ç½®</option><option>ä¿æŒåŸæ ·</option></select>
              </div>
              <label style="font-size: 13px;"><input type="checkbox" checked id="dap-buzzer"> å¼€å¯èœ‚é¸£å™¨</label>
            </fieldset>
          </div>

          <fieldset>
            <legend>ç¼–ç¨‹å‰</legend>
            <div style="display: flex; gap: 30px;">
              <label style="font-size: 13px;"><input type="checkbox"> æ£€æŸ¥æ˜¯å¦ä¸ºç©ºç‰‡</label>
              <label style="font-size: 13px;"><input type="checkbox"> åªæ ¡éªŒæ•°æ®è€Œä¸çƒ§å½•</label>
            </div>
          </fieldset>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; gap: 10px; height: 100%;">
          <div style="background: #111; padding: 10px; border-radius: 6px; border: 1px solid #444; font-size: 13px; color: #ccc;">
            <strong>æ“ä½œæ—¥å¿—ç»ˆç«¯</strong>
            <div style="float: right;">
              <button style="padding: 2px 8px; font-size: 11px; background: #555;" onclick="document.getElementById('dap-log').value=''">æ¸…ç©º</button>
            </div>
          </div>
          <textarea id="dap-log" readonly style="flex: 1; font-size: 13px; color: #00e676; line-height: 1.5; padding: 15px; font-family: 'Consolas', monospace;">[03/01-14:41:56:365] å½“å‰åº”ç”¨ç‰ˆæœ¬ä¸ºï¼š1.4.0.7...
[03/01-14:41:56:381] å½“å‰æ•°æ®åº“ç‰ˆæœ¬ä¸ºï¼š1.01.48...
[03/01-14:41:56:529] æ£€æµ‹åˆ°é©±åŠ¨å·²ç»å®‰è£…...
[03/01-14:41:56:898] å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ“ä½œã€‚</textarea>
        </div>
      </div>
    </div>

    <div id="dap-ob" class="dap-sub-page">
      <div style="overflow-y: auto; height: 100%; border: 1px solid #444; border-radius: 6px; background: #1a1a1a;">
        <table class="ob-table">
          <thead>
          <tr><th style="width: 40%;">åç§° (Option Name)</th><th style="width: 60%;">å‚æ•°å€¼ (Value / Configuration)</th></tr>
          </thead>
          <tbody>
          <tr><td>Read Out Protection (RDP)</td><td><select style="width: 100%; border: none; background: transparent; color: #fff;"><option selected>Level 0 (No Protection)</option><option>Level 1 (Read Protection)</option><option>Level 2 (Chip Protection)</option></select></td></tr>
          <tr><td>BOR Level (BOR_LEV)</td><td><select style="width: 100%; border: none; background: transparent; color: #fff;"><option>BOR Level 1 (2.0V)</option><option selected>BOR Level 2 (2.2V)</option><option>BOR Level 3 (2.5V)</option><option>BOR Level 4 (2.8V)</option></select></td></tr>
          <tr><td>Watchdog Selection (WDG_SW)</td><td><select style="width: 100%; border: none; background: transparent; color: #fff;"><option selected>Software Watchdog</option><option>Hardware Watchdog</option></select></td></tr>
          <tr><td>Reset on Standby (nRST_STDBY)</td><td><input type="checkbox" checked> Generate Reset</td></tr>
          <tr><td>Reset on Stop (nRST_STOP)</td><td><input type="checkbox" checked> Generate Reset</td></tr>
          <tr><td>Data0 (User Data)</td><td><input type="text" value="0xFF" style="background: transparent; border: none; width: 100%;"></td></tr>
          <tr><td>Data1 (User Data)</td><td><input type="text" value="0xFF" style="background: transparent; border: none; width: 100%;"></td></tr>
          </tbody>
        </table>
      </div>
      <div style="text-align: right; margin-top: 10px;"><button style="background: #28a745;">å†™å…¥é€‰é¡¹å­—èŠ‚ (Apply)</button></div>
    </div>

    <div id="dap-flash" class="dap-sub-page">
      <div style="background: #222; padding: 10px; border-radius: 6px 6px 0 0; border: 1px solid #444; border-bottom: none; display: flex; gap: 15px; align-items: center;">
        <span style="font-size: 13px;">èµ·å§‹åœ°å€: <input type="text" id="flash-start-addr" value="0x08000000" style="width: 100px;"></span>
        <span style="font-size: 13px;">é•¿åº¦: <input type="text" id="flash-length" value="0x1000" style="width: 80px;"></span>
        <button onclick="dapAction('readFlash')" style="padding: 4px 12px;">é‡æ–°è¯»å–æ•°æ®</button>
      </div>
      <div style="overflow: auto; flex: 1; border: 1px solid #444; border-radius: 0 0 6px 6px; background: #000;">
        <table class="hex-viewer" id="flash-hex-table">
          <thead>
          <tr>
            <th class="addr-col" style="width: 100px;">Address</th>
            <th>00</th><th>01</th><th>02</th><th>03</th><th>04</th><th>05</th><th>06</th><th>07</th>
            <th>08</th><th>09</th><th>0A</th><th>0B</th><th>0C</th><th>0D</th><th>0E</th><th>0F</th>
            <th style="color: #ccc; border-left: 2px solid #555;">ASCII Dump</th>
          </tr>
          </thead>
          <tbody id="flash-tbody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <div id="page-uart1" class="page">
    <div class="vofa-layout">
      <div class="vofa-sidebar">
        <div class="panel" style="flex: none;">
          <h3 class="section-title">âš™ï¸ æ•°æ®å¼•æ“ & é…ç½®</h3>
          <div class="control-row" style="margin-bottom: 12px;"><span class="cfg-label" style="color: #ff9800;">å¼•æ“</span><select id="u1-engine" style="border-color: #ff9800; color: #ff9800;"><option value="rawdata">RawData</option><option value="justfloat">JustFloat</option></select></div>
          <div class="control-row"><span class="cfg-label">æ³¢ç‰¹ç‡</span><select id="u1-baud"><option value="9600">9600</option><option value="115200" selected>115200</option><option value="2000000">2000000</option></select></div>
          <div class="control-row"><span class="cfg-label">æ•°æ®ä½</span><select id="u1-data"><option value="8" selected>8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option></select></div>
          <div class="control-row"><span class="cfg-label">åœæ­¢ä½</span><select id="u1-stop"><option value="1" selected>1</option><option value="1.5">1.5</option><option value="2">2</option></select></div>
          <div class="control-row"><span class="cfg-label">æ ¡éªŒä½</span><select id="u1-parity"><option value="0" selected>None</option><option value="1">Odd</option><option value="2">Even</option></select></div>
          <div class="control-row" style="margin-bottom: 10px;"><span class="cfg-label">æµæ§</span><select id="u1-flow"><option value="0" selected>None</option><option value="1">RTS/CTS</option><option value="2">XON/XOFF</option></select></div>
          <button onclick="applySerialConfig(1)" style="width: 100%;">åº”ç”¨å¼•æ“ä¸é…ç½®</button>
        </div>
        <div class="panel" style="flex: none;">
          <h3 class="section-title">ğŸ“¥ æ¥æ”¶è®¾ç½®</h3>
          <div class="toggle-group" style="margin-bottom: 10px;"><button id="rx-ascii-1" class="toggle-btn active" onclick="setRxMode(1, 'ascii')">ASCII</button><button id="rx-hex-1" class="toggle-btn" onclick="setRxMode(1, 'hex')">HEX</button></div>
          <button class="danger" onclick="document.getElementById('u1-rx').value=''" style="width: 100%;">æ¸…ç©ºæ¥æ”¶åŒº</button>
        </div>
        <div class="panel" style="flex: 1; display: flex; flex-direction: column; min-height: 150px;">
          <h3 class="section-title">ğŸ“¤ å‘é€åŒº</h3>
          <textarea id="u1-tx" placeholder="è¾“å…¥è¦å‘é€çš„æ•°æ®..." style="flex: 1; margin-bottom: 10px; color: #fff;"></textarea>
          <button onclick="sendCMD('TX_U1', document.getElementById('u1-tx').value)" style="width: 100%; background: #28a745;">ä¸€é”®å‘é€</button>
        </div>
      </div>
      <div class="vofa-main">
        <div class="panel vofa-scope">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 class="section-title" style="margin: 0; border: none;">ğŸ“ˆ UART 1 å®æ—¶æ³¢å½¢</h3>
            <div style="font-size: 12px; color: #888;">é‡‡æ ·ç‡: <span id="fps-counter-1" style="color:#00e676; font-weight: bold;">0</span> pts/s <button class="danger" style="padding: 2px 8px; margin-left: 10px; font-size: 11px;" onclick="clearChart(1)">æ¸…ç©º</button></div>
          </div>
          <div id="chart-container-1" style="flex: 1; background: #000; border-radius: 4px; border: 1px solid #444; width: 100%; overflow: hidden;"></div>
        </div>
        <div class="panel vofa-rx">
          <h3 class="section-title">ğŸ“„ è¯¦ç»†æ•°æ®æ—¥å¿—</h3>
          <textarea id="u1-rx" readonly placeholder="ç­‰å¾…æ¥æ”¶ UART 1 æ•°æ®..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <div id="page-uart2" class="page">
    <div class="vofa-layout">
      <div class="vofa-sidebar">
        <div class="panel" style="flex: none;">
          <h3 class="section-title">âš™ï¸ æ•°æ®å¼•æ“ & é…ç½®</h3>
          <div class="control-row" style="margin-bottom: 12px;"><span class="cfg-label" style="color: #ff9800;">å¼•æ“</span><select id="u2-engine" style="border-color: #ff9800; color: #ff9800;"><option value="rawdata">RawData</option><option value="justfloat">JustFloat</option></select></div>
          <div class="control-row"><span class="cfg-label">æ³¢ç‰¹ç‡</span><select id="u2-baud"><option value="9600">9600</option><option value="115200" selected>115200</option><option value="2000000">2000000</option></select></div>
          <div class="control-row"><span class="cfg-label">æ•°æ®ä½</span><select id="u2-data"><option value="8" selected>8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option></select></div>
          <div class="control-row"><span class="cfg-label">åœæ­¢ä½</span><select id="u2-stop"><option value="1" selected>1</option><option value="1.5">1.5</option><option value="2">2</option></select></div>
          <div class="control-row"><span class="cfg-label">æ ¡éªŒä½</span><select id="u2-parity"><option value="0" selected>None</option><option value="1">Odd</option><option value="2">Even</option></select></div>
          <div class="control-row" style="margin-bottom: 10px;"><span class="cfg-label">æµæ§</span><select id="u2-flow"><option value="0" selected>None</option><option value="1">RTS/CTS</option><option value="2">XON/XOFF</option></select></div>
          <button onclick="applySerialConfig(2)" style="width: 100%;">åº”ç”¨å¼•æ“ä¸é…ç½®</button>
        </div>
        <div class="panel" style="flex: none;">
          <h3 class="section-title">ğŸ“¥ æ¥æ”¶è®¾ç½®</h3>
          <div class="toggle-group" style="margin-bottom: 10px;"><button id="rx-ascii-2" class="toggle-btn active" onclick="setRxMode(2, 'ascii')">ASCII</button><button id="rx-hex-2" class="toggle-btn" onclick="setRxMode(2, 'hex')">HEX</button></div>
          <button class="danger" onclick="document.getElementById('u2-rx').value=''" style="width: 100%;">æ¸…ç©ºæ¥æ”¶åŒº</button>
        </div>
        <div class="panel" style="flex: 1; display: flex; flex-direction: column; min-height: 150px;">
          <h3 class="section-title">ğŸ“¤ å‘é€åŒº</h3>
          <textarea id="u2-tx" placeholder="è¾“å…¥è¦å‘é€çš„æ•°æ®..." style="flex: 1; margin-bottom: 10px; color: #fff;"></textarea>
          <button onclick="sendCMD('TX_U2', document.getElementById('u2-tx').value)" style="width: 100%; background: #28a745;">ä¸€é”®å‘é€</button>
        </div>
      </div>
      <div class="vofa-main">
        <div class="panel vofa-scope">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 class="section-title" style="margin: 0; border: none;">ğŸ“ˆ UART 2 å®æ—¶æ³¢å½¢</h3>
            <div style="font-size: 12px; color: #888;">é‡‡æ ·ç‡: <span id="fps-counter-2" style="color:#00e676; font-weight: bold;">0</span> pts/s <button class="danger" style="padding: 2px 8px; margin-left: 10px; font-size: 11px;" onclick="clearChart(2)">æ¸…ç©º</button></div>
          </div>
          <div id="chart-container-2" style="flex: 1; background: #000; border-radius: 4px; border: 1px solid #444; width: 100%; overflow: hidden;"></div>
        </div>
        <div class="panel vofa-rx">
          <h3 class="section-title">ğŸ“„ è¯¦ç»†æ•°æ®æ—¥å¿—</h3>
          <textarea id="u2-rx" readonly placeholder="ç­‰å¾…æ¥æ”¶ UART 2 æ•°æ®..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <div id="page-can" class="page">
    <div class="panel">
      <h3 class="section-title">å‘é€ CAN æŠ¥æ–‡</h3>
      <div class="control-row" style="margin-bottom: 15px;">
        <select id="can-type" style="width: auto;"><option value="STD">æ ‡å‡†å¸§</option><option value="EXT">æ‰©å±•å¸§</option></select>
        ID (Hex): <input type="text" id="can-id" placeholder="123" style="width: 100px;">
        Data (Hex): <input type="text" id="can-data" placeholder="11 22 33 44 55 66 77 88" style="flex: 1;">
        <button onclick="sendCMD('CAN_TX', document.getElementById('can-id').value + '|' + document.getElementById('can-data').value)">å‘é€æŠ¥æ–‡</button>
      </div>
      <h3 class="section-title">æ¥æ”¶è®°å½•</h3>
      <textarea id="can-rx" readonly placeholder="CAN æ€»çº¿æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
    </div>
  </div>

  <div id="page-i2c" class="page">
    <div class="panel">
      <h3 class="section-title">I2C Master æ“ä½œ</h3>
      <div class="control-row" style="margin-bottom: 15px;">
        Addr(Hex): <input type="text" id="i2c-addr" placeholder="50" style="width: 80px;">
        Reg(Hex): <input type="text" id="i2c-reg" placeholder="00" style="width: 80px;">
        <button onclick="sendCMD('I2C_READ', '')" style="background: #28a745;">è¯»å–æ•°æ®</button>
      </div>
      <div class="control-row" style="margin-bottom: 15px;">
        å†™å…¥æ•°æ®: <input type="text" id="i2c-write-data" placeholder="FF" style="flex: 1;">
        <button onclick="sendCMD('I2C_WRITE', '')" class="danger">å†™å…¥å¯„å­˜å™¨</button>
      </div>
      <textarea id="i2c-log" readonly placeholder="æ“ä½œæ—¥å¿—..."></textarea>
    </div>
  </div>

  <div id="page-pwm" class="page">
    <div class="panel" style="flex: none; margin: 0 auto; width: 100%; max-width: 800px; display: flex; flex-direction: column;">
      <h3 class="section-title">âš¡ PWM è¾“å‡ºé…ç½®ä¸ç›‘æ§</h3>

      <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div style="flex: 1;">
          <div class="control-row" style="margin-bottom: 15px;">
            <span class="cfg-label" style="width:80px;">PWM æ¨¡å¼:</span>
            <select id="pwm-mode" onchange="togglePwmUI()">
              <option value="high">é«˜é€Ÿ PWM (å›ºå®šç”µå¹³)</option>
              <option value="low">ä½é€Ÿ PWM (0-5Vå¯è°ƒ)</option>
            </select>
          </div>
          <div id="pwm-volt-container" style="background: #111; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #444;">
            <div id="pwm-volt-high">
              <span class="cfg-label" style="display:inline-block; width:80px; margin-bottom:10px;">è¾“å‡ºç”µå¹³:</span>
              <label style="margin-right: 20px;"><input type="radio" name="pwm-v-fixed" value="3.3" checked onchange="updateStaticCharts()"> 3.3V</label>
              <label><input type="radio" name="pwm-v-fixed" value="5.0" onchange="updateStaticCharts()"> 5.0V</label>
            </div>
            <div id="pwm-volt-low" style="display: none;">
              <div class="control-row">
                <span class="cfg-label" style="width:80px;">é«˜ç”µå¹³ç”µå‹:</span>
                <input type="number" id="pwm-v-custom" value="2.5" min="0" max="5" step="0.1" style="width: 100px;" oninput="updateStaticCharts()">
                <span style="color: #aaa; font-size: 13px;">V (0 - 5.0V)</span>
              </div>
            </div>
          </div>
        </div>

        <div style="flex: 1;">
          <div class="control-row" style="margin-bottom: 15px;">
            <span class="cfg-label" style="width:80px;">é¢‘ç‡ (Hz):</span>
            <input type="number" id="pwm-freq" value="100" style="flex: 1;" oninput="updateStaticCharts()">
          </div>
          <div class="control-row" style="margin-bottom: 25px; align-items: center;">
            <span class="cfg-label" style="width:80px;">å ç©ºæ¯”:</span>
            <input type="range" id="pwm-duty-slider" min="0" max="100" value="50" style="flex: 1;" oninput="syncPwmDuty('slider')">
            <div style="display: flex; align-items: center; margin-left: 10px;">
              <input type="number" id="pwm-duty-num" value="50" min="0" max="100" style="width: 60px; text-align: center; color: #0f0; font-weight: bold; background: #000;" oninput="syncPwmDuty('num')">
              <span style="color: #888; margin-left: 5px;">%</span>
            </div>
          </div>
          <div style="display: flex; gap: 15px;">
            <button onclick="sendPwmConfig()" style="flex: 1; font-size: 14px; padding: 10px; background: #007acc;">ğŸ“¥ å†™å…¥é…ç½®</button>
            <button id="btn-pwm-out" onclick="togglePwmOutput()" style="flex: 1; font-size: 14px; padding: 10px; background: #28a745;">â–¶ å¼€å¯è¾“å‡º</button>
          </div>
        </div>
      </div>

      <h3 class="section-title" style="margin-top: 5px;">ğŸ“ˆ é¢„æœŸæ³¢å½¢é™æ€é¢„è§ˆ (10msçª—å£ - æ‚¬æµ®æŸ¥çœ‹ç”µå‹)</h3>
      <div id="chart-container-pwm" style="flex: none; height: 120px; background: #000; border-radius: 4px; border: 1px solid #444; width: 100%; overflow: hidden; position: relative;"></div>

    </div>
  </div>

  <div id="page-dac" class="page">
    <div class="panel" style="flex: none; margin: 0 auto; width: 100%; max-width: 800px; display: flex; flex-direction: column;">
      <h3 class="section-title">âš¡ DAC 0-5V æ¨¡æ‹Ÿæ³¢å½¢ç”Ÿæˆ</h3>

      <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div style="flex: 1;">
          <div class="control-row" style="margin-bottom: 15px;">
            <span class="cfg-label" style="width:80px;">è¾“å‡ºæ¨¡å¼:</span>
            <select id="dac-mode" onchange="toggleDacUI()">
              <option value="dc">ç›´æµæ’å®šç”µå‹ (DC)</option>
              <option value="sine" selected>æ­£å¼¦æ³¢ (Sine)</option>
              <option value="triangle">ä¸‰è§’æ³¢ (Triangle)</option>
            </select>
          </div>
          <div class="control-row" id="dac-dc-div" style="margin-bottom: 15px; display: none;">
            <span class="cfg-label" style="width:80px;">æ’å®šç”µå‹:</span>
            <input type="number" id="dac-v-dc" value="2.5" min="0" max="5.0" step="0.01" style="width: 120px;" oninput="updateStaticCharts()">
            <span style="color: #aaa; font-size: 13px;">V (0 - 5.0V)</span>
          </div>
          <div id="dac-wave-div" style="background: #111; padding: 15px; border-radius: 6px; border: 1px solid #444; margin-bottom: 15px;">
            <div class="control-row" style="margin-bottom: 15px;">
              <span class="cfg-label" style="width:90px;">æ³¢å½¢é¢‘ç‡:</span>
              <input type="number" id="dac-freq" value="200" min="1" max="100000" style="width: 120px;" oninput="updateStaticCharts()">
              <span style="color: #aaa; font-size: 13px;">Hz</span>
            </div>
            <div class="control-row" style="margin-bottom: 15px;">
              <span class="cfg-label" style="width:90px;">å³°å³°å€¼ (Vpp):</span>
              <input type="number" id="dac-vpp" value="3.0" min="0" max="5.0" step="0.1" style="width: 120px;" oninput="updateStaticCharts()">
              <span style="color: #aaa; font-size: 13px;">V (æ³¢å¹…)</span>
            </div>
            <div class="control-row">
              <span class="cfg-label" style="width:90px;">ç›´æµåç½®:</span>
              <input type="number" id="dac-offset" value="1.5" min="0" max="5.0" step="0.1" style="width: 120px;" oninput="updateStaticCharts()">
              <span style="color: #aaa; font-size: 13px;">V (ä¸­è½´çº¿)</span>
            </div>
          </div>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 15px;">
          <div class="control-row" style="margin-bottom: 25px;">
            <span class="cfg-label" style="width:80px;">ç¡¬ä»¶ç¼“å†²:</span>
            <label class="switch">
              <input type="checkbox" id="dac-buffer" checked>
              <span class="slider"></span>
            </label>
            <span style="color: #888; font-size: 12px; margin-left: 10px;">å¼€å¯è¿æ”¾ç¼“å†²</span>
          </div>
          <button onclick="sendDacConfig()" style="width: 100%; font-size: 16px; padding: 12px; background: #d84315;">âš¡ æ‰§è¡Œè¾“å‡º</button>
        </div>
      </div>

      <h3 class="section-title" style="margin-top: 5px;">ğŸ“ˆ é¢„æœŸæ³¢å½¢é™æ€é¢„è§ˆ (10msçª—å£ - æ‚¬æµ®æŸ¥çœ‹ç”µå‹)</h3>
      <div id="chart-container-dac" style="flex: none; height: 120px; background: #000; border-radius: 4px; border: 1px solid #444; width: 100%; overflow: hidden; position: relative;"></div>

    </div>
  </div>

  <div id="page-sysset" class="page">
    <div class="sys-layout">
      <div class="sys-sidebar">
        <div class="sys-menu-item active" onclick="switchSysTab('basic', this)">åŸºæœ¬åå¥½è®¾ç½®</div>
        <div class="sys-menu-item" onclick="switchSysTab('display', this)">æ˜¾ç¤ºä¸ç•Œé¢</div>
        <div class="sys-menu-item" onclick="switchSysTab('about', this)">å…³äºæœ¬æœº</div>
      </div>
      <div class="sys-content">
        <div id="sys-tab-basic" class="sys-section active">
          <h3 class="section-title">ğŸµ äº¤äº’ä¸ä½“éªŒ</h3>
          <div class="control-row" style="margin-bottom: 20px;">
            <div style="flex: 1;"><div style="font-size: 14px; color: #fff; margin-bottom: 4px;">æŒ‰é’®éŸ³è‰²é€‰æ‹©</div><div style="font-size: 12px; color: #888;">è®¾ç½®æç¤ºéŸ³çš„éŸ³è‰²é¢‘ç‡</div></div>
            <input type="number" id="sys-tone" value="1.00" min="0" max="5" step="0.01" style="width: 100px; text-align: center;" onchange="updateSysConfig()">
          </div>
          <div class="control-row" style="margin-bottom: 20px;">
            <div style="flex: 1;"><div style="font-size: 14px; color: #fff; margin-bottom: 4px;">åˆ—è¡¨å¾ªç¯æ¨¡å¼</div><div style="font-size: 12px; color: #888;">å¼€å¯åæ•°æ®åˆ—è¡¨è‡ªåŠ¨å›åˆ°é¡¶éƒ¨</div></div>
            <label class="switch"><input type="checkbox" id="sys-loop" onchange="updateSysConfig()"><span class="slider"></span></label>
          </div>
        </div>
        <div id="sys-tab-display" class="sys-section">
          <h3 class="section-title">ğŸ“º å±å¹•ä¸ä¸»é¢˜</h3>
          <div class="control-row" style="margin-bottom: 20px;">
            <div style="flex: 1;"><div style="font-size: 14px; color: #fff; margin-bottom: 4px;">ç³»ç»Ÿä¸»é¢˜é£æ ¼</div></div>
            <select id="sys-theme" style="width: 150px;" onchange="updateSysConfig()"><option value="dark" selected>ğŸŒ™ æš—é»‘æ¨¡å¼</option><option value="light">â˜€ï¸ æ™®é€šæ¨¡å¼</option></select>
          </div>
          <div class="control-row" style="margin-bottom: 20px;">
            <div style="flex: 1;"><div style="font-size: 14px; color: #fff; margin-bottom: 4px;">å¼ºåˆ¶æ¨ªå±æ¨¡å¼</div></div>
            <label class="switch"><input type="checkbox" id="sys-landscape" checked onchange="updateSysConfig()"><span class="slider"></span></label>
          </div>
        </div>
        <div id="sys-tab-about" class="sys-section">
          <h3 class="section-title">â„¹ï¸ å…³äº Ultra Link</h3>
          <div style="background: #111; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #333;">
            <h1 style="color: #4fc3f7; margin: 0 0 10px 0;">Ultra Link BaseOS</h1>
            <p style="color: #888; font-size: 13px; margin: 0 0 20px 0;">Version: 2.1.0 Build 20260301</p>
            <hr style="border-color: #333; margin-bottom: 20px;">
            <div style="text-align: left; font-size: 13px; color: #ccc; line-height: 2;">
              <div><strong>ç¡¬ä»¶æ¶æ„:</strong> STM32/HPMicro Dual Core</div>
              <div><strong>é€šä¿¡æ¥å£:</strong> USB 2.0 High-Speed</div>
              <div><strong>DAP å¼•æ“:</strong> CMSIS-DAP v2.1</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="modal-overlay" id="chip-modal">
  <div class="modal-box">
    <div class="modal-header">
      <span>é€‰æ‹©èŠ¯ç‰‡ (è”åŠ¨æ•°æ®å­—å…¸)</span>
      <span class="modal-close" onclick="closeChipSelector()">âœ–</span>
    </div>
    <div class="modal-body">
      <div class="modal-col">
        <div class="modal-col-title">å“ç‰Œ (Brand):</div>
        <ul class="modal-list" id="chip-brand-list"></ul>
      </div>
      <div class="modal-col">
        <div class="modal-col-title">ç³»åˆ— (Series):</div>
        <ul class="modal-list" id="chip-series-list"></ul>
      </div>
      <div class="modal-col">
        <div class="modal-col-title">å‹å· (Model):</div>
        <ul class="modal-list" id="chip-model-list"></ul>
      </div>
    </div>
    <div class="modal-footer">
      <span>æŸ¥æ‰¾:</span>
      <input type="text" placeholder="è¾“å…¥å‹å·å¿«é€ŸæŸ¥æ‰¾">
      <span style="margin-left: 10px;">å·²é€‰:</span>
      <input type="text" id="modal-selected-chip" readonly style="background: #e9ecef; width: 150px; flex: none; font-weight: bold;">
      <button class="btn btn-ok" onclick="confirmChipSelection()">âœ” ç¡®å®š</button>
      <button class="btn btn-cancel" onclick="closeChipSelector()">âœ– å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // 1. é¡µé¢è·¯ç”±ä¸ UI åˆ‡æ¢
  // ==========================================
  function navTo(pageId, title) {
    document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.getElementById('page-title').innerText = title;
    document.getElementById('btn-back').style.display = 'inline-block';

    if(pageId === 'page-uart1') setTimeout(resizeChart1, 50);
    if(pageId === 'page-uart2') setTimeout(resizeChart2, 50);
    if(pageId === 'page-pwm') { setTimeout(resizeChartPWM, 50); updateStaticCharts(); }
    if(pageId === 'page-dac') { setTimeout(resizeChartDAC, 50); updateStaticCharts(); }
    if(pageId === 'page-dap') updateFlashData(0x08000000, null);
  }

  function goHome() {
    document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
    document.getElementById('page-home').classList.add('active');
    document.getElementById('page-title').innerText = 'Ultra Link æ€»æ§åˆ¶å°';
    document.getElementById('btn-back').style.display = 'none';
  }

  // ==========================================
  // 2. DAP é¡µé¢: èŠ¯ç‰‡è”åŠ¨å­—å…¸é€»è¾‘
  // ==========================================
  const chipDatabase = {
    "A1SEMI": {
      "ASM32F300 Series": ["ASM32F300B4DI", "ASM32F300B4QI", "ASM32F300D4DI", "ASM32F300F4BI"],
      "ASM32F310 Series": ["ASM32F310B4DI", "ASM32F310D4DI"]
    },
    "GigaDevice": {
      "GD32F10x Series": ["GD32F103C8T6", "GD32F103RET6"],
      "GD32F30x Series": ["GD32F303CCT6", "GD32F303ZET6"]
    },
    "STMicroelectronics": {
      "STM32F1 Series": ["STM32F103C8T6", "STM32F103VET6", "STM32F103ZET6"],
      "STM32H7 Series": ["STM32H743VIT6", "STM32H750VBT6"]
    },
    "HPMicro": {
      "HPM6700 Series": ["HPM6750IVK1", "HPM6750IVM1"],
      "HPM6300 Series": ["HPM6360IVK1"]
    }
  };

  let currentBrand = "";

  function initChipSelector() {
    const brandList = document.getElementById('chip-brand-list');
    brandList.innerHTML = '';
    Object.keys(chipDatabase).forEach(brand => {
      let li = document.createElement('li');
      li.innerText = brand;
      li.onclick = () => selectBrand(li, brand);
      brandList.appendChild(li);
    });
    selectBrand(brandList.firstChild, Object.keys(chipDatabase)[0]);
  }

  function selectBrand(el, brand) {
    document.querySelectorAll('#chip-brand-list li').forEach(li => li.classList.remove('active'));
    el.classList.add('active');
    currentBrand = brand;

    const seriesList = document.getElementById('chip-series-list');
    seriesList.innerHTML = '';
    const seriesData = chipDatabase[brand];
    Object.keys(seriesData).forEach(series => {
      let li = document.createElement('li');
      li.innerText = series;
      li.onclick = () => selectSeries(li, series);
      seriesList.appendChild(li);
    });
    if(seriesList.firstChild) selectSeries(seriesList.firstChild, Object.keys(seriesData)[0]);
  }

  function selectSeries(el, series) {
    document.querySelectorAll('#chip-series-list li').forEach(li => li.classList.remove('active'));
    el.classList.add('active');

    const modelList = document.getElementById('chip-model-list');
    modelList.innerHTML = '';
    const models = chipDatabase[currentBrand][series];
    models.forEach(model => {
      let li = document.createElement('li');
      li.innerText = model;
      li.onclick = () => selectModel(li, model);
      modelList.appendChild(li);
    });
    if(modelList.firstChild) selectModel(modelList.firstChild, models[0]);
  }

  function selectModel(el, modelName) {
    document.querySelectorAll('#chip-model-list li').forEach(li => li.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('modal-selected-chip').value = modelName;
  }

  function openChipSelector() { document.getElementById('chip-modal').classList.add('active'); }
  function closeChipSelector() { document.getElementById('chip-modal').classList.remove('active'); }

  function confirmChipSelection() {
    const chipName = document.getElementById('modal-selected-chip').value;
    document.getElementById('dap-mcu').value = chipName;
    closeChipSelector();
    dapAction('æˆåŠŸè½½å…¥èŠ¯ç‰‡é…ç½®: ' + chipName);
  }

  window.addEventListener('DOMContentLoaded', initChipSelector);

  // ==========================================
  // 3. DAP é¡µé¢ç‰¹å®šé€»è¾‘ (Tab ä¸ Flashæ•°æ®)
  // ==========================================
  function switchDapTab(tabId, el) {
    document.querySelectorAll('.dap-main-tab').forEach(item => item.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.dap-sub-page').forEach(sec => sec.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
  }

  function dapAction(actionName) {
    let log = document.getElementById('dap-log');
    let time = new Date().toLocaleTimeString();
    log.value += `\n[${time}] æ“ä½œ: ${actionName.toUpperCase()} ...`;
    log.scrollTop = log.scrollHeight;
    if(actionName === 'readFlash') {
      let addr = document.getElementById('flash-start-addr').value;
      log.value += `\n[${time}] ä» ${addr} è·å–æ•°æ®...`;
      updateFlashData(parseInt(addr, 16), null);
    }
  }

  function updateFlashData(startAddr, dataArray) {
    let tbody = document.getElementById('flash-tbody');
    tbody.innerHTML = '';
    for(let r = 0; r < 32; r++) {
      let tr = document.createElement('tr');
      let addrTd = document.createElement('td');
      addrTd.className = 'addr-col';
      addrTd.innerText = '0x' + (startAddr + r * 16).toString(16).toUpperCase().padStart(8, '0');
      tr.appendChild(addrTd);

      let asciiStr = '';
      for(let c = 0; c < 16; c++) {
        let td = document.createElement('td');
        let index = r * 16 + c;
        let val = (dataArray && dataArray.length > index) ? dataArray[index] : 0xFF;
        td.innerText = val.toString(16).toUpperCase().padStart(2, '0');
        tr.appendChild(td);
        asciiStr += (val >= 32 && val <= 126) ? String.fromCharCode(val) : '.';
      }

      let asciiTd = document.createElement('td');
      asciiTd.style.color = '#888';
      asciiTd.style.borderLeft = '2px solid #555';
      asciiTd.innerText = asciiStr;
      tr.appendChild(asciiTd);
      tbody.appendChild(tr);
    }
  }

  // ==========================================
  // 4. HEX/ASCII åˆ‡æ¢é€»è¾‘ (åŒä¸²å£)
  // ==========================================
  let rxMode = { 1: 'ascii', 2: 'ascii' };
  function setRxMode(portNum, mode) {
    rxMode[portNum] = mode;
    document.getElementById(`rx-ascii-${portNum}`).classList.remove('active');
    document.getElementById(`rx-hex-${portNum}`).classList.remove('active');
    document.getElementById(`rx-${mode}-${portNum}`).classList.add('active');
    document.getElementById(`u${portNum}-rx`).value = `--- å·²åˆ‡æ¢ä¸º ${mode.toUpperCase()} æ˜¾ç¤ºæ¨¡å¼ ---\n`;
  }

  // ==========================================
  // 5. è™šæ‹Ÿ USB è¿æ¥
  // ==========================================
  let isConnected = false;
  async function connectUSB() {
    alert("æ­£åœ¨è°ƒç”¨ WebUSB API è¯·æ±‚è¿æ¥è®¾å¤‡...");
    document.getElementById('usb-status').innerText = 'ğŸŸ¢ ç¡¬ä»¶å·²è¿æ¥';
    document.getElementById('usb-status').style.color = '#00e676';
    document.getElementById('btn-connect').style.display = 'none';
    document.getElementById('btn-disconnect').style.display = 'inline-block';
    isConnected = true;
  }
  function disconnectUSB() {
    document.getElementById('usb-status').innerText = 'â— æœªè¿æ¥';
    document.getElementById('usb-status').style.color = '#ff5252';
    document.getElementById('btn-connect').style.display = 'inline-block';
    document.getElementById('btn-disconnect').style.display = 'none';
    isConnected = false;
  }
  function sendCMD(cmdType, payload) { if (!isConnected) { alert("è¯·å…ˆè¿æ¥ç¡¬ä»¶ï¼"); return; } console.log("SEND:", cmdType); }
  function applySerialConfig(portNum) { if (!isConnected) { alert("è¯·å…ˆè¿æ¥ç¡¬ä»¶ï¼"); return; } document.getElementById(`u${portNum}-rx`).value += `\n>>> ä¸²å£é…ç½®å·²æ›´æ–°\n`; }

  // ==========================================
  // 6. UART åŠ¨æ€ç¤ºæ³¢å™¨
  // ==========================================
  const MAX_POINTS = 500;
  let chartData1 = [ Array(MAX_POINTS).fill(0), Array(MAX_POINTS).fill(0) ];
  let chartData2 = [ Array(MAX_POINTS).fill(0), Array(MAX_POINTS).fill(0) ];
  for(let i=0; i<MAX_POINTS; i++) { chartData1[0][i] = i; chartData2[0][i] = i; }

  const getUartOpts = (color, name) => ({
    width: 500, height: 200,
    axes: [{ stroke: "#666", grid: { stroke: "#333", width: 1 } }, { stroke: "#666", grid: { stroke: "#333", width: 1 } }],
    scales: { x: { time: false }, y: { auto: true } },
    series: [ {}, { label: name, stroke: color, width: 2 } ],
    cursor: { sync: { key: "scope" } }
  });

  const chartDiv1 = document.getElementById("chart-container-1");
  const uplot1 = new uPlot(getUartOpts("#ff9800", "UART 1"), chartData1, chartDiv1);
  const chartDiv2 = document.getElementById("chart-container-2");
  const uplot2 = new uPlot(getUartOpts("#b388ff", "UART 2"), chartData2, chartDiv2);

  function clearChart(portNum) {
    if(portNum === 1) { chartData1[1].fill(0); uplot1.setData(chartData1); }
    if(portNum === 2) { chartData2[1].fill(0); uplot2.setData(chartData2); }
  }
  function resizeChart1() { if(document.getElementById('page-uart1').classList.contains('active')) uplot1.setSize({ width: chartDiv1.clientWidth, height: chartDiv1.clientHeight }); }
  function resizeChart2() { if(document.getElementById('page-uart2').classList.contains('active')) uplot2.setSize({ width: chartDiv2.clientWidth, height: chartDiv2.clientHeight }); }

  // ==========================================
  // 7. PWM & DAC é™æ€æ³¢å½¢é¢„è§ˆ (å®Œå…¨é‡æ„ç‰ˆ - å«æ‚¬æµ®Tooltip)
  // ==========================================
  const STATIC_POINTS = 500;
  const TIME_WINDOW_MS = 10; // Xè½´å›ºå®šå±•ç¤º 10 æ¯«ç§’çš„çª—å£

  // ç”Ÿæˆå›ºå®šçš„ X è½´æ—¶é—´æ•°ç»„ (0 åˆ° 10ms)
  let staticTimeArray = new Float32Array(STATIC_POINTS);
  for(let i=0; i<STATIC_POINTS; i++) {
    staticTimeArray[i] = (i / (STATIC_POINTS - 1)) * TIME_WINDOW_MS;
  }

  // å®šä¹‰ Tooltip æ‚¬æµ®çª—æ’ä»¶ (æ ¸å¿ƒåŠŸèƒ½ï¼Œé¼ æ ‡æ”¾ä¸Šå»æ˜¾ç¤ºç”µå‹)
  function tooltipPlugin() {
    let tooltip;
    return {
      hooks: {
        init: u => {
          tooltip = document.createElement("div");
          tooltip.className = "u-tooltip";
          u.root.querySelector(".u-over").appendChild(tooltip);
        },
        setCursor: u => {
          const { left, top, idx } = u.cursor;
          if (idx === null || left < 0) {
            tooltip.style.display = "none";
            return;
          }
          tooltip.style.display = "block";

          // é˜²æ­¢ tooltip è¶…å‡ºå³ä¾§è¾¹ç•Œ
          if (left > u.bbox.width - 120) {
            tooltip.style.left = (left - 120) + "px";
          } else {
            tooltip.style.left = (left + 15) + "px";
          }
          tooltip.style.top = (top + 15) + "px";

          let t = u.data[0][idx].toFixed(2);
          let v = u.data[1][idx].toFixed(3);
          tooltip.innerHTML = `æ—¶é—´: <span style="color:#fff">${t} ms</span><br>ç”µå‹: <span class="val">${v} V</span>`;
        }
      }
    };
  }

  // é…ç½®å°å°ºå¯¸é™æ€å›¾ (å…³é—­é»˜è®¤å›¾ä¾‹ï¼Œä½¿ç”¨Tooltip)
  const getStaticOpts = (color) => ({
    width: 500, height: 120, // é«˜åº¦è¢«å‹ç¼©è‡³ 120px
    plugins: [tooltipPlugin()],
    legend: { show: false }, // å…³é—­å ç”¨ç©ºé—´çš„é»˜è®¤å›¾ä¾‹
    axes: [
      { stroke: "#ccc", grid: { stroke: "#333", width: 1 }, size: 25, space: 40 },
      { stroke: "#ccc", grid: { stroke: "#333", width: 1 }, size: 30 }
    ],
    scales: { x: { time: false }, y: { auto: false, range: [-0.5, 5.5] } }, // é”æ­» 0-5V èŒƒå›´
    series: [
      { label: "æ—¶é—´ (ms)" },
      { stroke: color, width: 2 }
    ],
    cursor: { drag: { setScale: false } }
  });

  const chartDivPWM = document.getElementById("chart-container-pwm");
  const uplotPWM = new uPlot(getStaticOpts("#00e676"), [[], []], chartDivPWM);

  const chartDivDAC = document.getElementById("chart-container-dac");
  const uplotDAC = new uPlot(getStaticOpts("#ffeb3b"), [[], []], chartDivDAC);

  function resizeChartPWM() { if(document.getElementById('page-pwm').classList.contains('active')) uplotPWM.setSize({ width: chartDivPWM.clientWidth, height: 120 }); }
  function resizeChartDAC() { if(document.getElementById('page-dac').classList.contains('active')) uplotDAC.setSize({ width: chartDivDAC.clientWidth, height: 120 }); }
  window.addEventListener("resize", () => { resizeChart1(); resizeChart2(); resizeChartPWM(); resizeChartDAC(); });

  // æ ¸å¿ƒï¼šæ ¹æ®é¢‘ç‡è®¡ç®—å¹¶é‡ç»˜é™æ€æ³¢å½¢ (ä½ æ”¹å˜é¢‘ç‡ï¼Œæ³¢å½¢å°±ä¼šç¬é—´å˜åŒ–)
  function updateStaticCharts() {
    // ---- è®¡ç®— PWM ----
    let modePWM = document.getElementById('pwm-mode').value;
    let vHigh = modePWM === 'high' ? parseFloat(document.querySelector('input[name="pwm-v-fixed"]:checked').value) : parseFloat(document.getElementById('pwm-v-custom').value);
    let freqPWM = parseFloat(document.getElementById('pwm-freq').value) || 1000;
    let duty = parseFloat(document.getElementById('pwm-duty-num').value) / 100.0;
    let periodPWM = 1000.0 / freqPWM; // å‘¨æœŸ(æ¯«ç§’)

    let pwmArray = new Float32Array(STATIC_POINTS);
    for(let i=0; i<STATIC_POINTS; i++) {
      let t = staticTimeArray[i];
      let phase = (t % periodPWM) / periodPWM;
      pwmArray[i] = (phase <= duty) ? vHigh : 0.0;
    }

    // ---- è®¡ç®— DAC ----
    let modeDAC = document.getElementById('dac-mode').value;
    let freqDAC = parseFloat(document.getElementById('dac-freq').value) || 1000;
    let vDC = parseFloat(document.getElementById('dac-v-dc').value);
    let vpp = parseFloat(document.getElementById('dac-vpp').value);
    let offset = parseFloat(document.getElementById('dac-offset').value);
    let periodDAC = 1000.0 / freqDAC; // å‘¨æœŸ(æ¯«ç§’)

    let dacArray = new Float32Array(STATIC_POINTS);
    for(let i=0; i<STATIC_POINTS; i++) {
      let t = staticTimeArray[i];
      if(modeDAC === 'dc') {
        dacArray[i] = vDC;
      } else if (modeDAC === 'sine') {
        dacArray[i] = offset + (vpp / 2.0) * Math.sin(2 * Math.PI * (t / periodDAC));
      } else if (modeDAC === 'triangle') {
        let phase = (t / periodDAC) % 1.0;
        dacArray[i] = offset + (vpp / 2.0) * (Math.abs(phase - 0.5) * 4 - 1);
      }
    }

    // å°†è®¡ç®—å¥½çš„å…¨é‡æ•°ç»„ä¸€æ¬¡æ€§å¡å…¥ï¼Œå½¢æˆé™æ€ç‰©ç†æ³¢å½¢
    uplotPWM.setData([Array.from(staticTimeArray), Array.from(pwmArray)]);
    uplotDAC.setData([Array.from(staticTimeArray), Array.from(dacArray)]);
  }

  // ==========================================
  // 8. PWM / DAC ä¸“å± UI é€»è¾‘
  // ==========================================
  function togglePwmUI() {
    const mode = document.getElementById('pwm-mode').value;
    if (mode === 'high') {
      document.getElementById('pwm-volt-high').style.display = 'block';
      document.getElementById('pwm-volt-low').style.display = 'none';
    } else {
      document.getElementById('pwm-volt-high').style.display = 'none';
      document.getElementById('pwm-volt-low').style.display = 'block';
    }
    updateStaticCharts();
  }

  function syncPwmDuty(source) {
    let slider = document.getElementById('pwm-duty-slider');
    let numInput = document.getElementById('pwm-duty-num');
    if (source === 'slider') { numInput.value = slider.value; }
    else if (source === 'num') {
      let val = parseInt(numInput.value);
      if(val > 100) val = 100;
      if(val < 0) val = 0;
      numInput.value = val; slider.value = val;
    }
    if (pwmIsOn) sendPwmConfig();
    updateStaticCharts(); // æ›´æ–°é™æ€æ³¢å½¢
  }

  let pwmIsOn = false;
  function togglePwmOutput() {
    const btn = document.getElementById('btn-pwm-out');
    pwmIsOn = !pwmIsOn;
    if(pwmIsOn) {
      btn.innerText = 'â¹ åœæ­¢è¾“å‡º'; btn.style.background = '#cc3300'; sendPwmConfig();
    } else {
      btn.innerText = 'â–¶ å¼€å¯è¾“å‡º'; btn.style.background = '#28a745';
    }
  }

  function sendPwmConfig() { console.log("PWM CFG å†™å…¥"); }

  function toggleDacUI() {
    const mode = document.getElementById('dac-mode').value;
    if (mode === 'dc') {
      document.getElementById('dac-dc-div').style.display = 'flex';
      document.getElementById('dac-wave-div').style.display = 'none';
    } else {
      document.getElementById('dac-dc-div').style.display = 'none';
      document.getElementById('dac-wave-div').style.display = 'block';
    }
    updateStaticCharts();
  }
  function sendDacConfig() { console.log("DAC CFG å†™å…¥"); }

  // ==========================================
  // 9. ç³»ç»Ÿè®¾ç½® é¡µé¢é€»è¾‘
  // ==========================================
  function switchSysTab(tabId, el) {
    document.querySelectorAll('.sys-menu-item').forEach(item => item.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.sys-section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('sys-tab-' + tabId).classList.add('active');
  }

  function updateSysConfig() {
    let sysConfig = { theme: document.getElementById('sys-theme').value };
    if(sysConfig.theme === 'light') {
      document.documentElement.style.setProperty('--bg', '#f0f2f5');
      document.documentElement.style.setProperty('--panel', '#ffffff');
      document.documentElement.style.setProperty('--text', '#333333');
    } else {
      document.documentElement.style.setProperty('--bg', '#1e1e1e');
      document.documentElement.style.setProperty('--panel', '#2d2d2d');
      document.documentElement.style.setProperty('--text', '#eaeaea');
    }
  }
</script>
</body>
</html>
