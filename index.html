<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Ultra Link å¤šåŠŸèƒ½è°ƒè¯•ç»ˆç«¯</title>
    <link rel="stylesheet" href="https://unpkg.com/uplot/dist/uPlot.min.css">
    <script src="https://unpkg.com/uplot/dist/uPlot.iife.min.js"></script>

    <style>
        :root { --bg: #1e1e1e; --panel: #2d2d2d; --primary: #007acc; --text: #eaeaea; --danger: #cc3300; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .topbar { background: #111; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; z-index: 10; }
        .topbar h2 { margin: 0; font-size: 1.2rem; color: #4fc3f7; }
        button { background: var(--primary); color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px; font-size: 14px; transition: 0.2s; }
        button:hover { background: #005f9e; }
        button.danger { background: var(--danger); }
        button.back-btn { background: #555; margin-right: 15px; }
        .view-container { flex: 1; padding: 20px; overflow-y: auto; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; max-width: 1000px; margin: 40px auto; }
        .menu-card { background: var(--panel); border: 1px solid #444; border-radius: 12px; padding: 30px 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .menu-card h3 { margin: 0 0 10px 0; color: #4fc3f7; }
        .panel { background: var(--panel); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444; }
        textarea { width: 100%; height: 300px; background: #000; color: #0f0; border: 1px solid #555; padding: 10px; box-sizing: border-box; font-family: 'Consolas', monospace; resize: vertical; }
        .control-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        input { background: #111; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="topbar">
        <div style="display: flex; align-items: center;">
            <button id="btn-back" class="back-btn" style="display: none;" onclick="goHome()">â—€ è¿”å›ä¸»èœå•</button>
            <h2 id="page-title">Ultra Link æ€»æ§åˆ¶å°</h2>
        </div>
        <div>
            <span id="usb-status" style="color: #ff5252; margin-right: 15px; font-weight: bold;">â— æœªè¿æ¥ (Workerä¼‘çœ )</span>
            <button id="btn-connect" onclick="connectUSB()">è¿æ¥ç¡¬ä»¶</button>
            <button id="btn-disconnect" class="danger" onclick="disconnectUSB()" style="display:none;">æ–­å¼€è¿æ¥</button>
        </div>
    </div>

    <div class="view-container">
        <div id="page-home" class="page active">
            <div class="menu-grid">
                <div class="menu-card" onclick="navTo('page-uart1', 'UART 1 è°ƒè¯•ç»ˆç«¯')">
                    <h3>UART 1</h3><p>å…¨åŠŸèƒ½ä¸²å£æ”¶å‘</p>
                </div>
                <div class="menu-card" onclick="navTo('page-scope', 'å¤šé€šé“å®æ—¶ç¤ºæ³¢å™¨')" style="border-color: #ff9800;">
                    <h3 style="color: #ff9800;">ğŸ“ˆ å®æ—¶æ³¢å½¢ (Scope)</h3><p>é«˜æ€§èƒ½å¤šçº¿ç¨‹æ¸²æŸ“å¼•æ“</p>
                </div>
                <div class="menu-card" onclick="navTo('page-dap', 'DAP ä»¿çœŸä¸çƒ§å½•')">
                    <h3>DAPLink</h3><p>å›ºä»¶ä¸‹è½½ / å¤ä½æ§åˆ¶</p>
                </div>
            </div>
        </div>

        <div id="page-uart1" class="page">
            <div class="panel">
                <textarea id="u1-rx" readonly placeholder="ç­‰å¾…æ¥æ”¶å¤šçº¿ç¨‹ä¸²å£æ•°æ®..."></textarea>
                <div class="control-group" style="margin-top: 15px;">
                    <input type="text" id="u1-tx" placeholder="å‘é€æŒ‡ä»¤..." style="flex: 1;">
                    <button onclick="sendUSBString('TX_U1', document.getElementById('u1-tx').value)">å‘é€</button>
                </div>
            </div>
        </div>

        <div id="page-scope" class="page">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>é‡‡æ ·ç‡: <span id="fps-counter" style="color:#00e676">0</span> ç‚¹/ç§’</span>
                    <button onclick="clearChart()" class="danger">æ¸…ç©ºæ³¢å½¢</button>
                </div>
                <div id="chart-container" style="background: #000; border: 1px solid #444; border-radius: 4px; padding: 10px;"></div>
            </div>
        </div>

        <div id="page-dap" class="page">
            <div class="panel">
                <button class="danger" onclick="sendUSBString('DAP_SYS_RESET', '')">ç³»ç»Ÿå¤ä½ (Reset)</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // UI è·¯ç”±é€»è¾‘
        // ==========================================
        function navTo(pageId, title) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.getElementById('page-title').innerText = title;
            document.getElementById('btn-back').style.display = 'inline-block';
        }

        function goHome() {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-home').classList.add('active');
            document.getElementById('page-title').innerText = 'Ultra Link æ€»æ§åˆ¶å°';
            document.getElementById('btn-back').style.display = 'none';
        }

        // ==========================================
        // å¤šçº¿ç¨‹ Web Worker é€šä¿¡æ¶æ„æ ¸å¿ƒ
        // ==========================================
        const worker = new Worker('usb-worker.js'); // å¯åŠ¨åå°å¤§ç®¡å®¶
        let isConnected = false;

        // ç›‘å¬åå°å¤§ç®¡å®¶å‘æ¥çš„æ±‡æŠ¥
        worker.onmessage = (event) => {
            const msg = event.data;

            if (msg.type === 'STATUS') {
                if (msg.data === 'CONNECTED') {
                    document.getElementById('usb-status').innerText = 'ğŸŸ¢ å·²è¿æ¥ (å¤šçº¿ç¨‹å°±ç»ª)';
                    document.getElementById('usb-status').style.color = '#00e676';
                    document.getElementById('btn-connect').style.display = 'none';
                    document.getElementById('btn-disconnect').style.display = 'inline-block';
                    isConnected = true;
                } else if (msg.data === 'DISCONNECTED') {
                    document.getElementById('usb-status').innerText = 'â— æœªè¿æ¥';
                    document.getElementById('usb-status').style.color = '#ff5252';
                    document.getElementById('btn-connect').style.display = 'inline-block';
                    document.getElementById('btn-disconnect').style.display = 'none';
                    isConnected = false;
                }
            }
            else if (msg.type === 'ERROR') {
                alert("Worker é”™è¯¯: " + msg.data);
            }
            else if (msg.type === 'UART1_RX') {
                // å¤„ç†ä¸²å£æ–‡æœ¬
                let ta = document.getElementById('u1-rx');
                ta.value += msg.data;
                ta.scrollTop = ta.scrollHeight;
            }
            else if (msg.type === 'WAVE_DATA') {
                // å¤„ç†æ³¢å½¢æ•°ç»„
                updateChartData(msg.data);
            }
        };

        // ç”¨æˆ·ç‚¹å‡»è¿æ¥æŒ‰é’® (å¿…é¡»åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œæƒé™è¯·æ±‚)
        async function connectUSB() {
            try {
                // 1. å¼¹å‡ºç³»ç»Ÿçº§æˆæƒçª—å£
                await navigator.usb.requestDevice({ filters: [] });
                // 2. æ‹¿åˆ°æˆæƒåï¼Œé€šçŸ¥åå° Worker æ¥ç®¡ç‰©ç†æ¥å£å¹¶å¯åŠ¨ç›‘å¬æ­»å¾ªç¯
                worker.postMessage({ cmd: 'CONNECT' });
            } catch (error) {
                alert('æˆæƒå¤±è´¥æˆ–è¢«å–æ¶ˆ: ' + error.message);
            }
        }

        function disconnectUSB() {
            worker.postMessage({ cmd: 'DISCONNECT' });
        }

        // ç»Ÿä¸€å‘åŒ…å‡½æ•°ï¼šä¸»çº¿ç¨‹ä¸ç¢°ç¡¬ä»¶ï¼ŒåªæŠŠä»»åŠ¡æ´¾å‘ç»™ Worker
        function sendUSBString(cmdType, payload) {
            if (!isConnected) { alert("è¯·å…ˆè¿æ¥ç¡¬ä»¶ï¼"); return; }
            let packetStr = JSON.stringify({ cmd: cmdType, data: payload });
            const dataBuffer = new TextEncoder().encode(packetStr);
            worker.postMessage({ cmd: 'SEND_DATA', payload: dataBuffer });
        }

        // ==========================================
        // é«˜æ€§èƒ½ uPlot ç¤ºæ³¢å™¨æ¸²æŸ“å¼•æ“
        // ==========================================
        const MAX_POINTS = 500; // å±å¹•ä¸Šæœ€å¤šä¿ç•™ 500 ä¸ªç‚¹ï¼Œå½¢æˆæ»šåŠ¨æ•ˆæœ
        let chartData = [
            Array(MAX_POINTS).fill(0), // Xè½´ (æ—¶é—´åºåˆ—ï¼Œç®€å•çš„ç´¢å¼•)
            Array(MAX_POINTS).fill(0)  // Yè½´ (ä½ çš„ç”µå‹/ADCå€¼)
        ];
        // åˆå§‹åŒ– X è½´ç´¢å¼•
        for(let i=0; i<MAX_POINTS; i++) chartData[0][i] = i;

        // é…ç½® uPlot (æš—é»‘æå®¢é£æ ¼)
        let opts = {
            width: 800, height: 400,
            axes: [
                { stroke: "#ccc", grid: { stroke: "#333", width: 1 } },
                { stroke: "#ccc", grid: { stroke: "#333", width: 1 } }
            ],
            scales: { x: { time: false }, y: { auto: true } },
            series: [
                {}, // Xè½´é…ç½®ç©ºç½®
                { stroke: "#00e676", width: 2 } // Yè½´æ³¢å½¢çº¿é¢œè‰²(è§å…‰ç»¿)
            ]
        };

        const uplot = new uPlot(opts, chartData, document.getElementById("chart-container"));
        let totalPointsReceived = 0;

        // æ¥æ”¶æ¥è‡ª Worker çš„æ‰¹é‡ç‚¹é˜µï¼Œæ¨å…¥å›¾è¡¨æ›´æ–°
        function updateChartData(newPointsArray) {
            totalPointsReceived += newPointsArray.length;

            // å°†æ–°æ•°æ®è¿½åŠ åˆ°æ•°ç»„æœ«å°¾ï¼Œå¹¶æŠŠæ•°ç»„å¤´éƒ¨çš„è€æ•°æ®æŒ¤å‡ºå» (å®ç°æµæ°´æ»šåŠ¨æ•ˆæœ)
            for(let i=0; i<newPointsArray.length; i++) {
                chartData[1].push(newPointsArray[i]);
                chartData[1].shift();
            }

            // æé€Ÿé‡ç»˜
            uplot.setData(chartData);
        }

        // ç®€æ˜“çš„é‡‡æ ·ç‡ç»Ÿè®¡ä»ª (æ¯ç§’æ›´æ–°ä¸€æ¬¡)
        setInterval(() => {
            document.getElementById('fps-counter').innerText = totalPointsReceived;
            totalPointsReceived = 0;
        }, 1000);

        function clearChart() {
            chartData[1].fill(0);
            uplot.setData(chartData);
        }
    </script>
</body>
</html>