<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Ultra Link ç»¼åˆæ§åˆ¶å°</title>
    <link rel="stylesheet" href="https://unpkg.com/uplot/dist/uPlot.min.css">
    <script src="https://unpkg.com/uplot/dist/uPlot.iife.min.js"></script>
    
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --primary: #007acc; --text: #e0e0e0; --border: #333; }
        body { font-family: 'Consolas', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .topbar { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); z-index: 10; flex-shrink: 0; }
        .topbar h2 { margin: 0; font-size: 1.2rem; color: #4fc3f7; letter-spacing: 1px; }
        button { background: var(--primary); color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 13px; transition: 0.2s; font-weight: bold; }
        button:hover { background: #005f9e; }
        button.danger { background: #cc3300; }
        button.danger:hover { background: #990000; }
        
        input, select { background: #000; border: 1px solid #555; color: #0f0; padding: 5px; border-radius: 3px; font-family: monospace; outline: none; }
        input:focus { border-color: var(--primary); }

        /* æ ¸å¿ƒç½‘æ ¼å¸ƒå±€ (Dashboard) */
        .dashboard { flex: 1; display: grid; grid-template-rows: auto 1fr auto; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; overflow-y: auto; }
        
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 8px; }
        .panel-header h3 { margin: 0; font-size: 14px; color: #ffb300; }
        
        /* åŒºåŸŸåˆ†é… */
        .scope-area { grid-column: 1 / -1; height: 280px; } /* æ³¢å½¢å æ»¡æœ€ä¸Šæ–¹ä¸€æ•´è¡Œ */
        .uart1-area { grid-column: 1 / 2; height: 250px; } /* å·¦è¾¹ä¸²å£1 */
        .uart2-area { grid-column: 2 / 3; height: 250px; } /* å³è¾¹ä¸²å£2 */
        
        /* åº•éƒ¨æ§åˆ¶åŒºï¼šå°† CAN, I2C, PWM, DAC æ’æˆä¸€æ’ */
        .controls-area { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }

        textarea { flex: 1; width: 100%; background: #0a0a0a; color: #00e676; border: 1px solid #444; padding: 8px; box-sizing: border-box; font-family: monospace; resize: none; font-size: 13px; border-radius: 4px; margin-bottom: 8px; }
        .input-row { display: flex; gap: 8px; align-items: center; }
        .input-row input[type="text"] { flex: 1; }
        
        /* ç¾åŒ–æ»‘åŠ¨æ¡ */
        input[type=range] { flex: 1; cursor: pointer; }
    </style>
</head>
<body>

    <div class="topbar">
        <h2>Ultra Link ç»¼åˆæ§åˆ¶å°</h2>
        <div>
            <span id="usb-status" style="color: #ff5252; margin-right: 15px; font-weight: bold;">â— æœªè¿æ¥ç¡¬ä»¶</span>
            <button id="btn-connect" onclick="connectUSB()">ğŸš€ è¿æ¥ç¡¬ä»¶ (WebUSB)</button>
            <button id="btn-disconnect" class="danger" style="display:none;" onclick="disconnectUSB()">æ–­å¼€</button>
        </div>
    </div>

    <div class="dashboard">
        
        <div class="panel scope-area">
            <div class="panel-header">
                <h3>ğŸ“ˆ å®æ—¶å¤šçº¿ç¨‹ç¤ºæ³¢å™¨</h3>
                <div style="font-size: 12px; color: #888;">
                    é‡‡æ ·ç‡: <span id="fps-counter" style="color:#0f0; font-weight: bold;">0</span> pts/s 
                    <button class="danger" style="padding: 2px 8px; margin-left: 10px;" onclick="clearChart()">æ¸…ç©º</button>
                </div>
            </div>
            <div id="chart-container" style="flex: 1; background: #000; border-radius: 4px; overflow: hidden; position: relative;"></div>
        </div>

        <div class="panel uart1-area">
            <div class="panel-header">
                <h3>ğŸ“Ÿ UART 1 (ä¸»æ§é€šä¿¡)</h3>
                <select id="u1-baud" style="font-size: 11px; padding: 2px;">
                    <option value="115200">115200</option>
                    <option value="2000000">2M</option>
                </select>
            </div>
            <textarea id="u1-rx" readonly placeholder="æ¥æ”¶åˆ°çš„æ•°æ®..."></textarea>
            <div class="input-row">
                <input type="text" id="u1-tx" placeholder="å‘é€æŒ‡ä»¤...">
                <button onclick="sendCMD('TX_U1', document.getElementById('u1-tx').value)">å‘é€</button>
                <button class="danger" onclick="document.getElementById('u1-rx').value=''">æ¸…ç©º</button>
            </div>
        </div>

        <div class="panel uart2-area">
            <div class="panel-header">
                <h3>ğŸ“Ÿ UART 2 (è¾…åŠ©ç›‘æ§)</h3>
                <select id="u2-baud" style="font-size: 11px; padding: 2px;">
                    <option value="9600">9600</option>
                    <option value="115200" selected>115200</option>
                </select>
            </div>
            <textarea id="u2-rx" readonly placeholder="æ¥æ”¶åˆ°çš„æ•°æ®..."></textarea>
            <div class="input-row">
                <input type="text" id="u2-tx" placeholder="å‘é€æŒ‡ä»¤...">
                <button onclick="sendCMD('TX_U2', document.getElementById('u2-tx').value)">å‘é€</button>
                <button class="danger" onclick="document.getElementById('u2-rx').value=''">æ¸…ç©º</button>
            </div>
        </div>

        <div class="controls-area">
            
            <div class="panel">
                <div class="panel-header"><h3>ğŸšŒ CAN æ€»çº¿</h3></div>
                <div class="input-row" style="margin-bottom: 5px;">
                    <input type="text" id="can-id" placeholder="ID (Hex)" style="width: 60px;">
                    <select id="can-type"><option>STD</option><option>EXT</option></select>
                </div>
                <div class="input-row">
                    <input type="text" id="can-data" placeholder="Data (Hex) ç©ºæ ¼éš”å¼€" style="font-size: 11px;">
                    <button onclick="sendCMD('CAN_TX', document.getElementById('can-id').value + '|' + document.getElementById('can-data').value)">å‘</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header"><h3>ğŸ”Œ I2C Master</h3></div>
                <div class="input-row" style="margin-bottom: 5px;">
                    <input type="text" id="i2c-addr" placeholder="Addr(Hex)" style="width: 45%;">
                    <input type="text" id="i2c-reg" placeholder="Reg(Hex)" style="width: 45%;">
                </div>
                <div class="input-row">
                    <input type="text" id="i2c-data" placeholder="Write Data(Hex)">
                    <button onclick="sendCMD('I2C_W', '')">å†™</button>
                    <button onclick="sendCMD('I2C_R', '')" style="background:#28a745;">è¯»</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header"><h3>âš¡ PWM è¾“å‡º</h3></div>
                <div class="input-row" style="margin-bottom: 10px;">
                    <span style="font-size: 12px; color: #aaa;">é¢‘ç‡:</span>
                    <input type="number" id="pwm-freq" value="10000" style="width: 60px;"> Hz
                </div>
                <div class="input-row">
                    <input type="range" id="pwm-duty" min="0" max="100" value="50" oninput="document.getElementById('pwm-val').innerText = this.value + '%'">
                    <span id="pwm-val" style="width: 35px; font-size: 12px; text-align: right;">50%</span>
                    <button onclick="sendCMD('PWM_SET', document.getElementById('pwm-freq').value + '|' + document.getElementById('pwm-duty').value)">è®¾</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header"><h3>ğŸ“‰ DAC æ¨¡æ‹Ÿè¾“å‡º</h3></div>
                <div class="input-row" style="margin-top: 10px;">
                    <input type="number" id="dac-val" placeholder="0 - 3300" style="flex:1;">
                    <span style="font-size: 12px; color: #aaa;">mV</span>
                    <button onclick="sendCMD('DAC_SET', document.getElementById('dac-val').value)">è¾“å‡º</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const worker = new Worker('usb-worker.js'); 
        let isConnected = false;

        // 1. ç›‘å¬åå°å‘æ¥çš„æ•°æ®
        worker.onmessage = (event) => {
            const msg = event.data;

            if (msg.type === 'STATUS') {
                if (msg.data === 'CONNECTED') {
                    document.getElementById('usb-status').innerText = 'ğŸŸ¢ ç¡¬ä»¶å·²è¿æ¥';
                    document.getElementById('usb-status').style.color = '#00e676';
                    document.getElementById('btn-connect').style.display = 'none';
                    document.getElementById('btn-disconnect').style.display = 'inline-block';
                    isConnected = true;
                } else if (msg.data === 'DISCONNECTED') {
                    document.getElementById('usb-status').innerText = 'â— æœªè¿æ¥';
                    document.getElementById('usb-status').style.color = '#ff5252';
                    document.getElementById('btn-connect').style.display = 'inline-block';
                    document.getElementById('btn-disconnect').style.display = 'none';
                    isConnected = false;
                }
            } 
            else if (msg.type === 'UART1_RX') {
                let ta = document.getElementById('u1-rx');
                ta.value += msg.data;
                ta.scrollTop = ta.scrollHeight; // è‡ªåŠ¨æ»šå±
            }
            else if (msg.type === 'UART2_RX') {
                let ta = document.getElementById('u2-rx');
                ta.value += msg.data;
                ta.scrollTop = ta.scrollHeight;
            }
            else if (msg.type === 'WAVE_DATA') {
                updateChartData(msg.data);
            }
        };

        // 2. æŒ‰é’®äº‹ä»¶ï¼šè¿æ¥/æ–­å¼€/å‘é€æŒ‡ä»¤
        async function connectUSB() {
            try {
                // å¿…é¡»åœ¨ä¸»çº¿ç¨‹è§¦å‘æµè§ˆå™¨æˆæƒå¼¹çª—
                await navigator.usb.requestDevice({ filters: [] });
                worker.postMessage({ cmd: 'CONNECT' });
            } catch (error) {
                console.warn('è¿æ¥å–æ¶ˆæˆ–å¤±è´¥:', error);
            }
        }

        function disconnectUSB() {
            worker.postMessage({ cmd: 'DISCONNECT' });
        }

        // å‘é€é€šç”¨æŒ‡ä»¤ç»™åå° Worker
        function sendCMD(cmdType, payload) {
            if (!isConnected) { alert("è¯·å…ˆè¿æ¥ç¡¬ä»¶ï¼"); return; }
            let packetStr = JSON.stringify({ cmd: cmdType, data: payload });
            const dataBuffer = new TextEncoder().encode(packetStr);
            worker.postMessage({ cmd: 'SEND_DATA', payload: dataBuffer });
        }

        // 3. é«˜æ€§èƒ½ uPlot ç¤ºæ³¢å™¨åˆå§‹åŒ–
        const MAX_POINTS = 500; 
        let chartData = [
            Array(MAX_POINTS).fill(0), // Xè½´ (æ—¶é—´åºåˆ—)
            Array(MAX_POINTS).fill(0)  // Yè½´ (æ•°å€¼)
        ];
        for(let i=0; i<MAX_POINTS; i++) chartData[0][i] = i;

        // è·å–æ³¢å½¢å®¹å™¨çš„å¤§å°ï¼ŒåŠ¨æ€é€‚é…
        const chartDiv = document.getElementById("chart-container");
        let opts = {
            width: chartDiv.clientWidth, 
            height: chartDiv.clientHeight - 5, // ç¨å¾®å‡ä¸€ç‚¹é˜²æ­¢å‡ºç°æ»šåŠ¨æ¡
            axes: [
                { stroke: "#666", grid: { stroke: "#222", width: 1 } },
                { stroke: "#666", grid: { stroke: "#222", width: 1 } }
            ],
            scales: { x: { time: false }, y: { auto: true } },
            series: [
                {}, 
                { stroke: "#ffb300", width: 2 } // Yè½´æ³¢å½¢çº¿é¢œè‰²
            ],
            cursor: { sync: { key: "scope" } } // å¯ç”¨ç‚«é…·çš„åå­—å…‰æ ‡
        };

        const uplot = new uPlot(opts, chartData, chartDiv);
        let totalPointsReceived = 0;

        function updateChartData(newPointsArray) {
            totalPointsReceived += newPointsArray.length;
            
            // æ»šåŠ¨æ•°ç»„æœºåˆ¶
            for(let i=0; i<newPointsArray.length; i++) {
                chartData[1].push(newPointsArray[i]);
                chartData[1].shift();
            }
            uplot.setData(chartData);
        }

        // FPS / é‡‡æ ·ç‡ç»Ÿè®¡
        setInterval(() => {
            document.getElementById('fps-counter').innerText = totalPointsReceived;
            totalPointsReceived = 0;
        }, 1000);

        function clearChart() {
            chartData[1].fill(0);
            uplot.setData(chartData);
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶è‡ªåŠ¨é‡ç»˜å›¾è¡¨å°ºå¯¸
        window.addEventListener("resize", () => {
            uplot.setSize({ width: chartDiv.clientWidth, height: chartDiv.clientHeight - 5 });
        });
    </script>
</body>
</html>
